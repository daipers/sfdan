---
phase: "05-visualization-selfassessment"
plan: "01"
type: "execute"
wave: 1
depends_on: []
files_modified:
  - "src/components/DashboardMetrics.tsx"
  - "src/components/AgencyChart.tsx"
  - "src/lib/agency-stats.ts"
  - "src/app/api/agency-stats/route.ts"
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Users can view aggregate statistics across federal agencies"
    - "Users can compare agency performance via bar charts"
    - "Dashboard displays total spending and average scores by agency"
    - "Charts are responsive on mobile devices"
  artifacts:
    - path: "src/components/AgencyChart.tsx"
      provides: "Bar/pie chart component for agency comparison"
      exports: "AgencyChart component with agency metrics"
    - path: "src/lib/agency-stats.ts"
      provides: "Aggregation logic for agency-level statistics"
      exports: "calculateAgencyStats function"
    - path: "src/app/api/agency-stats/route.ts"
      provides: "API endpoint for aggregated agency data"
      exports: "GET handler returning agency statistics"
  key_links:
    - from: "src/components/DashboardMetrics.tsx"
      to: "src/components/AgencyChart.tsx"
      via: "import and render"
      pattern: "import.*AgencyChart"
    - from: "src/components/AgencyChart.tsx"
      to: "/api/agency-stats"
      via: "fetch in useEffect"
      pattern: "fetch.*api/agency-stats"
---

<objective>
Add agency comparison charts to the dashboard for visualizing aggregate scoring patterns across federal agencies.

Purpose: Users (especially journalists and analysts) want to compare agency-level compliance performance and identify trends.
Output: Agency comparison charts on the dashboard showing average scores and total spending by agency
</objective>

<execution_context>
@./.planning/phases/04-details-leadgen/04-03-SUMMARY.md
@./.planning/ROADMAP.md
</execution_context>

<context>
@./.planning/PROJECT.md
@./src/components/DashboardMetrics.tsx
@./src/lib/scoring.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agency stats aggregation library</name>
  <files>src/lib/agency-stats.ts</files>
  <action>
    Create src/lib/agency-stats.ts:
    - Export calculateAgencyStats function that accepts award[]
    - Group awards by awarding_agency_name
    - Calculate for each agency:
      - total_spending: sum of federal_action_obligation
      - project_count: number of awards
      - avg_score: average procedural compliance score
      - score_distribution: count of green/yellow/red projects
    - Return sorted array by total_spending descending
    - Handle missing agency names gracefully (group as "Unknown")
  </action>
  <verify>
    npx tsc --noEmit && node -e "require('./src/lib/agency-stats.ts')"</verify>
  <done>
    AgencyStats type defined, calculateAgencyStats function exported
  </done>
</task>

<task type="auto">
  <name>Task 2: Create agency-stats API endpoint</name>
  <files>src/app/api/agency-stats/route.ts</files>
  <action>
    Create Next.js API route at src/app/api/agency-stats/route.ts:
    - GET handler that fetches all awards (or cached subset)
    - Call calculateAgencyStats from lib/agency-stats
    - Return JSON with agency statistics array
    - Cache response for 1 hour (use existing caching pattern)
  </action>
  <verify>
    npm run build && curl -s http://localhost:3000/api/agency-stats | head -c 200</verify>
  <done>
    /api/agency-stats returns JSON with agency statistics
  </done>
</task>

<task type="auto">
  <name>Task 3: Create AgencyChart component</name>
  <files>src/components/AgencyChart.tsx</files>
  <action>
    Create AgencyChart component at src/components/AgencyChart.tsx:
    - Accept agencyStats array prop
    - Render bar chart showing top 10 agencies by total spending
    - Color bars by average score (green ≥80, yellow ≥60, red <60)
    - Show tooltip on hover with detailed stats
    - Use recharts library (already installed in Phase 3)
    - Make responsive: full width on mobile, max 600px on desktop
    - Include aria-labels for accessibility
  </action>
  <verify>
    npx tsc --noEmit && ls src/components/AgencyChart.tsx</verify>
  <done>
    AgencyChart renders bar chart with agency comparison data
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate charts into dashboard</name>
  <files>src/components/DashboardMetrics.tsx</files>
  <action>
    Update src/components/DashboardMetrics.tsx:
    - Import AgencyChart component
    - Fetch agency stats from /api/agency-stats on mount
    - Add new section below KPI cards showing "Agency Comparison"
    - Display chart with loading state
    - Handle errors gracefully with fallback message
  </action>
  <verify>
    npm run build && grep -q "AgencyChart" src/components/DashboardMetrics.tsx</verify>
  <done>
    Dashboard displays agency comparison chart below KPI cards
  </done>
</task>

</tasks>

<verification>
- [ ] Agency stats API returns data for top agencies
- [ ] Bar chart displays with proper coloring
- [ ] Tooltips show detailed statistics
- [ ] Chart is responsive on mobile
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
</verification>

<success_criteria>
Users can view agency comparison charts showing:
- Total spending by agency (bar chart)
- Average compliance score per agency
- Score distribution (color-coded)
</success_criteria>

<output>
After completion, create `.planning/phases/05-visualization-selfassessment/05-01-SUMMARY.md`
</output>
