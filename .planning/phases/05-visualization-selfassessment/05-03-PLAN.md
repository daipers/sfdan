---
phase: "05-visualization-selfassessment"
plan: "03"
type: "execute"
wave: 1
depends_on: []
files_modified:
  - "src/app/api/export/route.ts"
  - "src/components/ExportButton.tsx"
  - "src/components/DataTable.tsx"
  - "src/lib/export.ts"
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Users can export filtered project data to CSV"
    - "Users can export full dataset to Excel format"
    - "Export includes all relevant columns including scores"
    - "Export respects current filter state"
  artifacts:
    - path: "src/app/api/export/route.ts"
      provides: "API endpoint for data export"
      exports: "GET handler returning CSV/Excel"
    - path: "src/lib/export.ts"
      provides: "CSV/Excel generation utilities"
      exports: "generateCSV, generateExcel functions"
    - path: "src/components/ExportButton.tsx"
      provides: "UI component for export options"
      exports: "ExportButton component"
  key_links:
    - from: "src/components/DataTable.tsx"
      to: "src/components/ExportButton.tsx"
      via: "import and render"
      pattern: "import.*ExportButton"
    - from: "src/components/ExportButton.tsx"
      to: "/api/export"
      via: "fetch with filter params"
      pattern: "fetch.*api/export"
---

<objective>
Add data export functionality allowing users to download project data in CSV and Excel formats with current filters applied.

Purpose: Journalists, researchers, and analysts need to download data for offline analysis and story research. This increases site utility and return visits.
Output: Export buttons on dashboard allowing CSV/Excel download
</objective>

<execution_context>
@./.planning/phases/04-details-leadgen/04-03-SUMMARY.md
@./.planning/ROADMAP.md
</execution_context>

<context>
@./.planning/PROJECT.md
@./src/components/DataTable.tsx
@./src/lib/projects.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export utility library</name>
  <files>src/lib/export.ts</files>
  <action>
    Create src/lib/export.ts:
    - Export generateCSV function:
      - Accepts array of award objects
      - Returns CSV string with headers
      - Columns: award_id, project_name, agency, state, amount, score, score_breakdown, date
    - Export generateExcel function:
      - Uses xlsx library (install if needed: npm install xlsx)
      - Creates workbook with projects sheet
      - Adds summary sheet with filter stats
    - Export transformForExport function:
      - Maps award data to export format
      - Handles missing values gracefully
  </action>
  <verify>
    npx tsc --noEmit && node -e "require('./src/lib/export.ts')"</verify>
  <done>
    CSV and Excel generation functions exported
  </done>
</task>

<task type="auto">
  <name>Task 2: Create export API endpoint</name>
  <files>src/app/api/export/route.ts</files>
  <action>
    Create Next.js API route at src/app/api/export/route.ts:
    - GET handler with query params for filters (state, agency, search, etc.)
    - Parse filter params and fetch matching awards
    - Support format query param: csv or xlsx
    - Generate appropriate output using export lib
    - Set correct Content-Type and Content-Disposition headers
    - Limit exports to 10,000 rows max (warn user if exceeded)
  </action>
  <verify>
    npm run build && curl -s "http://localhost:3000/api/export?format=csv" | head -c 200</verify>
  <done>
    /api/export returns downloadable CSV/Excel file
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ExportButton component</name>
  <files>src/components/ExportButton.tsx</files>
  <action>
    Create ExportButton component at src/components/ExportButton.tsx:
    - Accept current filter state as props
    - Dropdown or split-button with options: "Export CSV", "Export Excel"
    - Show row count estimate before export
    - On click, fetch from /api/export with current filters
    - Trigger browser download with filename: sfdan-export-{date}.{csv|xlsx}
    - Show loading state during export
    - Handle errors with toast notification
    - Style consistently with dashboard
  </action>
  <verify>
    npx tsc --noEmit && ls src/components/ExportButton.tsx</verify>
  <done>
    ExportButton renders with CSV/Excel download options
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate export into dashboard</name>
  <files>src/components/DataTable.tsx</files>
  <action>
    Update src/components/DataTable.tsx:
    - Import ExportButton component
    - Add export button in table header area (above or below table)
    - Pass current filter state to ExportButton
    - Ensure button is visible but not intrusive
    - Add keyboard shortcut hint (e.g., "Ctrl+S to export")
  </action>
  <verify>
    npm run build && grep -q "ExportButton" src/components/DataTable.tsx</verify>
  <done>
    Dashboard table includes export functionality
  </done>
</task>

</tasks>

<verification>
- [ ] CSV export downloads with correct data
- [ ] Excel export downloads with formatted workbook
- [ ] Exports respect current filter state
- [ ] Large exports show warning/limitation
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
</verification>

<success_criteria>
Users can:
- Export current view to CSV format
- Export current view to Excel format
- Download respects applied filters (state, agency, search)
- Exported data includes score information
</success_criteria>

<output>
After completion, create `.planning/phases/05-visualization-selfassessment/05-03-SUMMARY.md`
</output>
