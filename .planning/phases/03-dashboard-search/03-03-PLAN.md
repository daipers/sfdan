---
phase: 03-dashboard-search
plan: 03
type: execute
wave: 3
depends_on:
  - 03-02
files_modified:
  - src/components/DashboardMetrics.tsx
  - src/components/DataTable.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Summary metrics show total spending and project counts"
    - "Average compliance score is displayed"
    - "Dashboard works on mobile devices"
    - "Table columns hide appropriately on small screens"
  artifacts:
    - path: "src/components/DashboardMetrics.tsx"
      provides: "KPI cards using Tremor"
      exports: ["DashboardMetrics"]
      min_lines: 40
    - path: "src/components/DataTable.tsx"
      provides: "Responsive column visibility"
      contains: "hidden sm:table-cell"
      contains: "hidden md:table-cell"
  key_links:
    - from: "DashboardMetrics"
      to: "searchResult.metrics"
      via: "props"
      pattern: "metrics.totalSpending"
---

<objective>
Add Tremor-based summary metrics and finalize mobile responsiveness for the dashboard.

Purpose: Complete the dashboard with KPI cards and ensure full mobile compatibility.
Output: Working dashboard with metrics + responsive table
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-dashboard-search/03-RESEARCH.md
@.planning/phases/03-dashboard-search/03-02-PLAN.md
@src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Create DashboardMetrics component with Tremor</name>
  <files>src/components/DashboardMetrics.tsx</files>
  <action>
Create KPI cards using Tremor for summary metrics. Follow the research patterns.

```typescript
// src/components/DashboardMetrics.tsx
'use client'

import { Card, Metric, Text, Flex, BadgeDelta } from '@tremor/react'

interface SummaryMetrics {
  totalSpending: number
  projectCount: number
  avgScore: number
}

interface DashboardMetricsProps {
  metrics: SummaryMetrics
}

export function DashboardMetrics({ metrics }: DashboardMetricsProps) {
  const formatCurrency = (amount: number) => {
    if (amount >= 1e9) {
      return `$${(amount / 1e9).toFixed(1)}B`
    }
    if (amount >= 1e6) {
      return `$${(amount / 1e6).toFixed(1)}M`
    }
    return `$${(amount / 1e3).toFixed(0)}K`
  }

  const getScoreColor = (score: number) => {
    if (score >= 80) return 'text-green-600'
    if (score >= 60) return 'text-yellow-600'
    return 'text-red-600'
  }

  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {/* Total Spending */}
      <Card className="bg-white">
        <Text className="text-gray-600">Total Spending</Text>
        <Metric className="text-gray-900">
          {formatCurrency(metrics.totalSpending)}
        </Metric>
        <Text className="text-xs text-gray-500 mt-1">
          Across {metrics.projectCount.toLocaleString()} projects
        </Text>
      </Card>

      {/* Project Count */}
      <Card className="bg-white">
        <Text className="text-gray-600">Projects Analyzed</Text>
        <Metric className="text-gray-900">
          {metrics.projectCount.toLocaleString()}
        </Metric>
        <Text className="text-xs text-gray-500 mt-1">
          IIJA infrastructure awards
        </Text>
      </Card>

      {/* Average Score */}
      <Card className="bg-white">
        <Text className="text-gray-600">Avg. Compliance Score</Text>
        <Flex alignItems="items-baseline" className="gap-2">
          <Metric className={getScoreColor(metrics.avgScore)}>
            {metrics.avgScore}
          </Metric>
          <Text className="text-gray-500">/ 100</Text>
        </Flex>
        <Text className="text-xs text-gray-500 mt-1">
          {metrics.avgScore >= 80 
            ? 'High procedural compliance'
            : metrics.avgScore >= 60 
              ? 'Medium compliance - review recommended'
              : 'Low compliance - investigation suggested'}
        </Text>
      </Card>
    </div>
  )
}
```

Key patterns:
- Use Tremor Card, Metric, Text, Flex components
- Responsive grid (1 col mobile, 2 cols tablet, 3 cols desktop)
- Currency formatting with B/M/K suffixes
- Score color coding matches AwardCard pattern
</action>
  <verify>npx tsc --noEmit src/components/DashboardMetrics.tsx</verify>
  <done>DashboardMetrics compiles, uses Tremor components, renders 3 KPI cards with proper formatting</done>
</task>

<task type="auto">
  <name>Enhance DataTable mobile responsiveness</name>
  <files>src/components/DataTable.tsx</files>
  <action>
Update the DataTable component to improve mobile responsiveness. The columns already have meta.className for visibility, but enhance the overall layout.

Key changes:
1. Ensure table container scrolls horizontally on small screens
2. Make pagination controls stack on mobile
3. Add aria-labels for accessibility

Update the pagination section in DataTable.tsx:

```typescript
// Replace the pagination controls section with this enhanced version:
<div className="flex flex-col sm:flex-row items-center justify-between px-2 py-4 gap-4">
  <div className="text-sm text-gray-500 order-2 sm:order-1">
    Showing {pagination.pageIndex * pagination.pageSize + 1} to{' '}
    {Math.min((pagination.pageIndex + 1) * pagination.pageSize, rowCount)} of {rowCount} results
  </div>
  <div className="flex items-center gap-2 order-1 sm:order-2 flex-wrap justify-center">
    <button
      className="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
      onClick={() => onPaginationChange({ ...pagination, pageIndex: 0 })}
      disabled={pagination.pageIndex === 0}
      aria-label="First page"
    >
      First
    </button>
    <button
      className="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
      onClick={() => onPaginationChange({ ...pagination, pageIndex: pagination.pageIndex - 1 })}
      disabled={pagination.pageIndex === 0}
      aria-label="Previous page"
    >
      Prev
    </button>
    <span className="text-sm px-2">
      Page {pagination.pageIndex + 1} of {pageCount}
    </span>
    <button
      className="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
      onClick={() => onPaginationChange({ ...pagination, pageIndex: pagination.pageIndex + 1 })}
      disabled={pagination.pageIndex >= pageCount - 1}
      aria-label="Next page"
    >
      Next
    </button>
    <button
      className="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
      onClick={() => onPaginationChange({ ...pagination, pageIndex: pageCount - 1 })}
      disabled={pagination.pageIndex >= pageCount - 1}
      aria-label="Last page"
    >
      Last
    </button>
  </div>
</div>
```

Also add aria-label to the table element:
```typescript
<table className="w-full text-sm" aria-label="IIJA Projects">
```

The column visibility (hidden sm:table-cell, hidden md:table-cell, hidden lg:table-cell) is already configured in the columns definition from Plan 02.
</action>
  <verify>npx tsc --noEmit src/components/DataTable.tsx</verify>
  <done>DataTable has responsive pagination controls, aria-labels, and column visibility for mobile</done>
</task>

<task type="checkpoint:human-verify">
  <what-built>
Complete dashboard with:
- Filter sidebar (search, state, agency, category)
- Data table with server-side pagination and sorting
- Summary metrics (total spending, project count, avg score)
- Mobile responsive layout with collapsible filters
  </what-built>
  <how-to-verify>
**Step 1: Start the dev server**
```bash
npm run dev
```

**Step 2: Open the dashboard**
Visit http://localhost:3000

**Step 3: Test filters**
- Type a search term (e.g., "highway") - should filter results after 300ms debounce
- Select a state filter - should update URL and results
- Select an agency filter - should combine with AND logic
- Click "Clear Filters" - should reset all filters

**Step 4: Test pagination**
- Click Next/Previous - should navigate pages
- Verify page count matches data

**Step 5: Test mobile responsiveness**
- Resize browser to mobile width (~375px)
- Verify: filters collapse into expandable section
- Verify: table scrolls horizontally
- Verify: columns hide appropriately (only Project + Score visible)

**Step 6: Verify metrics**
- Check that Total Spending, Projects Analyzed, Avg Score display correctly
- Verify formatting ($B/$M for amounts, commas for counts)
  </how-to-verify>
  <resume-signal>Type "approved" to proceed or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] DashboardMetrics renders 3 KPI cards using Tremor
- [ ] DataTable pagination controls stack on mobile
- [ ] aria-labels added for accessibility
- [ ] All filters work with AND logic
- [ ] URL state persists on refresh
- [ ] Mobile layout is functional
</verification>

<success_criteria>
- Summary metrics display total spending, project count, and average score
- Dashboard is fully responsive on mobile devices
- All Phase 3 requirements met (FILT-01 to FILT-05, TABL-01 to TABL-05)
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-search/03-03-SUMMARY.md`
</output>
