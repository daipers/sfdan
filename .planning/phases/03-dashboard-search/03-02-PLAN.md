---
phase: 03-dashboard-search
plan: 02
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - src/components/DataTable.tsx
  - src/components/FilterSidebar.tsx
  - src/app/page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Users can see awards in a sortable, paginated table"
    - "Users can filter by state, agency, and category"
    - "Multiple filters combine with AND logic"
    - "URL reflects current filter/sort/page state"
  artifacts:
    - path: "src/components/DataTable.tsx"
      provides: "TanStack Table with manual pagination/sorting"
      exports: ["DataTable"]
      min_lines: 80
    - path: "src/components/FilterSidebar.tsx"
      provides: "Filter controls with nuqs binding"
      exports: ["FilterSidebar"]
      min_lines: 60
    - path: "src/app/page.tsx"
      provides: "Dashboard page integrating all components"
      contains: "loadDashboardParams"
  key_links:
    - from: "FilterSidebar"
      to: "URL params"
      via: "nuqs useQueryStates"
      pattern: "useQueryStates"
    - from: "URL params"
      to: "DataTable"
      via: "props from server component"
      pattern: "pagination.*onPaginationChange"
    - from: "page.tsx"
      to: "searchProjects"
      via: "server-side data fetch"
      pattern: "searchProjects.*params"
---

<objective>
Build the data table and filter components using TanStack Table and nuqs for type-safe URL state management.

Purpose: Enable users to view, sort, and filter IIJA projects with proper pagination and URL state persistence.
Output: Working DataTable + FilterSidebar integrated into dashboard
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-dashboard-search/03-RESEARCH.md
@.planning/phases/03-dashboard-search/03-01-PLAN.md
@src/lib/api.ts
@src/lib/search-params.ts
@src/lib/scoring.ts
@src/components/AwardCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Create DataTable component with TanStack Table</name>
  <files>src/components/DataTable.tsx</files>
  <action>
Create a client-side DataTable component using TanStack Table v8 with manual pagination and sorting. Use the patterns from the research.

```typescript
// src/components/DataTable.tsx
'use client'

import {
  useReactTable,
  getCoreRowModel,
  flexRender,
  ColumnDef,
  PaginationState,
  SortingState,
} from '@tanstack/react-table'
import { getScoreColorClass, getScoreDescription } from '@/lib/scoring'

interface Award {
  'Award ID': string
  'Description'?: string
  'Recipient Name'?: string
  'Awarding Agency'?: string
  'Funding Agency'?: string
  'Award Amount'?: number
  'Start Date'?: string
  'End Date'?: string
  score?: {
    environmental: number
    competitiveBidding: number
    modificationAuth: number
    total: number
  }
}

interface DataTableProps {
  data: Award[]
  pageCount: number
  rowCount: number
  pagination: PaginationState
  sorting: SortingState
  onPaginationChange: (pagination: PaginationState) => void
  onSortingChange: (sorting: SortingState) => void
}

const columns: ColumnDef<Award>[] = [
  {
    accessorKey: 'Description',
    header: 'Project',
    cell: ({ row }) => (
      <div className="max-w-xs">
        <div className="font-medium truncate" title={row.original['Description']}>
          {row.original['Description'] || row.original['Award ID'] || 'Untitled'}
        </div>
        <div className="text-xs text-gray-500 truncate">
          {row.original['Recipient Name']}
        </div>
      </div>
    ),
  },
  {
    accessorKey: 'score.total',
    header: 'Score',
    cell: ({ row }) => {
      const score = row.original.score?.total
      if (score === undefined) return <span className="text-gray-400">—</span>
      return (
        <span className={`px-2 py-1 rounded text-sm font-medium ${getScoreColorClass(score)}`}>
          {score}
        </span>
      )
    },
    meta: { className: 'w-20' },
  },
  {
    accessorKey: 'Award Amount',
    header: 'Amount',
    cell: ({ row }) => {
      const amount = row.original['Award Amount'] || 0
      return (
        <span className="font-medium text-green-700">
          {amount >= 1000000 
            ? `$${(amount / 1000000).toFixed(1)}M` 
            : `$${(amount / 1000).toFixed(0)}K`}
        </span>
      )
    },
    meta: { className: 'w-28 hidden sm:table-cell' },
  },
  {
    accessorKey: 'Awarding Agency',
    header: 'Agency',
    cell: ({ row }) => (
      <span className="text-sm">{row.original['Awarding Agency'] || 'N/A'}</span>
    ),
    meta: { className: 'hidden md:table-cell' },
  },
  {
    accessorKey: 'Start Date',
    header: 'Start Date',
    cell: ({ row }) => {
      const date = row.original['Start Date']
      return date ? (
        <span className="text-sm text-gray-600">
          {new Date(date).toLocaleDateString()}
        </span>
      ) : <span className="text-gray-400">—</span>
    },
    meta: { className: 'hidden lg:table-cell' },
  },
]

export function DataTable({
  data,
  pageCount,
  rowCount,
  pagination,
  sorting,
  onPaginationChange,
  onSortingChange,
}: DataTableProps) {
  const table = useReactTable({
    data,
    columns,
    getCoreRowModel: getCoreRowModel(),
    
    // Server-side pagination
    manualPagination: true,
    pageCount,
    rowCount,
    state: { pagination, sorting },
    onPaginationChange,
    onSortingChange,
    
    // Server-side sorting
    manualSorting: true,
  })

  return (
    <div className="w-full">
      <div className="rounded-lg border border-gray-200 overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-50 border-b border-gray-200">
              {table.getHeaderGroups().map(headerGroup => (
                <tr key={headerGroup.id}>
                  {headerGroup.headers.map(header => (
                    <th
                      key={header.id}
                      className={`px-4 py-3 text-left font-medium text-gray-700 ${header.column.columnDef.meta?.className || ''}`}
                    >
                      {header.isPlaceholder
                        ? null
                        : flexRender(
                            header.column.columnDef.header,
                            header.getContext()
                          )}
                    </th>
                  ))}
                </tr>
              ))}
            </thead>
            <tbody className="divide-y divide-gray-200 bg-white">
              {table.getRowModel().rows.map(row => (
                <tr 
                  key={row.id} 
                  className="hover:bg-gray-50 cursor-pointer"
                  onClick={() => {
                    // Future: Navigate to detail page
                    console.log('Clicked award:', row.original['Award ID'])
                  }}
                >
                  {row.getVisibleCells().map(cell => (
                    <td 
                      key={cell.id}
                      className={`px-4 py-3 ${cell.column.columnDef.meta?.className || ''}`}
                    >
                      {flexRender(cell.column.columnDef.cell, cell.getContext())}
                    </td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
      
      {/* Pagination Controls */}
      <div className="flex items-center justify-between px-2 py-4">
        <div className="text-sm text-gray-500">
          Showing {pagination.pageIndex * pagination.pageSize + 1} to{' '}
          {Math.min((pagination.pageIndex + 1) * pagination.pageSize, rowCount)} of {rowCount} results
        </div>
        <div className="flex items-center gap-2">
          <button
            className="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            onClick={() => onPaginationChange({ ...pagination, pageIndex: 0 })}
            disabled={pagination.pageIndex === 0}
          >
            First
          </button>
          <button
            className="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            onClick={() => onPaginationChange({ ...pagination, pageIndex: pagination.pageIndex - 1 })}
            disabled={pagination.pageIndex === 0}
          >
            Previous
          </button>
          <span className="text-sm">
            Page {pagination.pageIndex + 1} of {pageCount}
          </span>
          <button
            className="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            onClick={() => onPaginationChange({ ...pagination, pageIndex: pagination.pageIndex + 1 })}
            disabled={pagination.pageIndex >= pageCount - 1}
          >
            Next
          </button>
          <button
            className="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            onClick={() => onPaginationChange({ ...pagination, pageIndex: pageCount - 1 })}
            disabled={pagination.pageIndex >= pageCount - 1}
          >
            Last
          </button>
        </div>
      </div>
    </div>
  )
}
```

Key patterns:
- Manual pagination and sorting (server-side)
- Responsive column visibility via meta.className
- Score badge with color coding
- Click handler placeholder for future detail pages
</action>
  <verify>npx tsc --noEmit src/components/DataTable.tsx</verify>
  <done>DataTable component compiles, uses TanStack Table with manual pagination/sorting, renders score badges</done>
</task>

<task type="auto">
  <name>Create FilterSidebar component with nuqs</name>
  <files>src/components/FilterSidebar.tsx</files>
  <action>
Create a client-side filter sidebar using nuqs for URL state management. Include debounced search input.

```typescript
// src/components/FilterSidebar.tsx
'use client'

import { useQueryStates, parseAsString, parseAsStringLiteral, parseAsInteger } from 'nuqs'
import { US_STATES, FEDERAL_AGENCIES, PROJECT_CATEGORIES } from '@/lib/search-params'

export function FilterSidebar() {
  const [params, setParams] = useQueryStates({
    q: parseAsString.withDefault('').withOptions({ 
      debounceMs: 300,
      shallow: false, // Trigger server re-fetch
    }),
    state: parseAsString,
    agency: parseAsString,
    category: parseAsStringLiteral(PROJECT_CATEGORIES),
    page: parseAsInteger.withDefault(1),
  })

  const updateFilter = (key: string, value: string | null) => {
    // Reset to page 1 when filter changes
    setParams({ [key]: value, page: 1 })
  }

  const clearFilters = () => {
    setParams({
      q: null,
      state: null,
      agency: null,
      category: null,
      page: 1,
    })
  }

  const hasActiveFilters = params.state || params.agency || params.category || params.q

  return (
    <aside className="space-y-4">
      {/* Search Input */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Search
        </label>
        <input
          type="text"
          placeholder="Search projects..."
          value={params.q}
          onChange={(e) => updateFilter('q', e.target.value || null)}
          className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        />
      </div>

      {/* State Filter */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          State
        </label>
        <select
          value={params.state ?? ''}
          onChange={(e) => updateFilter('state', e.target.value || null)}
          className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
          <option value="">All States</option>
          {US_STATES.map(s => (
            <option key={s} value={s}>{s}</option>
          ))}
        </select>
      </div>

      {/* Agency Filter */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Agency
        </label>
        <select
          value={params.agency ?? ''}
          onChange={(e) => updateFilter('agency', e.target.value || null)}
          className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
          <option value="">All Agencies</option>
          {FEDERAL_AGENCIES.map(a => (
            <option key={a} value={a}>{a}</option>
          ))}
        </select>
      </div>

      {/* Category Filter */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Category
        </label>
        <select
          value={params.category ?? ''}
          onChange={(e) => updateFilter('category', e.target.value || null)}
          className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
          <option value="">All Categories</option>
          {PROJECT_CATEGORIES.map(c => (
            <option key={c} value={c}>
              {c.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
            </option>
          ))}
        </select>
      </div>

      {/* Clear Filters */}
      {hasActiveFilters && (
        <button
          onClick={clearFilters}
          className="w-full px-3 py-2 text-sm text-gray-600 hover:text-gray-900 border border-gray-300 rounded-md hover:bg-gray-50"
        >
          Clear Filters
        </button>
      )}
    </aside>
  )
}
```

Key patterns:
- nuqs useQueryStates for all filter state
- 300ms debounce on search input
- Reset to page 1 on filter change
- Clear filters button when any filter active
</action>
  <verify>npx tsc --noEmit src/components/FilterSidebar.tsx</verify>
  <done>FilterSidebar compiles, uses nuqs useQueryStates, has all four filter controls with clear button</done>
</task>

<task type="auto">
  <name>Integrate components into dashboard page</name>
  <files>src/app/page.tsx</files>
  <action>
Rewrite the main dashboard page to use the new DataTable, FilterSidebar, and server-side search. Keep the existing DataCurrencyBadge and methodology link.

```typescript
// src/app/page.tsx
import { fetchLastUpdated } from "@/lib/usaspending";
import { searchProjects } from "@/lib/api";
import { loadDashboardParams } from "@/lib/search-params";
import { DataCurrencyBadge } from "@/components/DataCurrencyBadge";
import { DataTable } from "@/components/DataTable";
import { FilterSidebar } from "@/components/FilterSidebar";
import { DashboardMetrics } from "@/components/DashboardMetrics";
import Link from "next/link";
import { PaginationState, SortingState } from "@tanstack/react-table";

export const dynamic = 'force-dynamic';

// Client component wrapper for table interactivity
function TableWrapper({ 
  data, 
  pageCount, 
  totalCount,
  initialPage,
  initialSort,
  initialOrder,
}: { 
  data: any[]
  pageCount: number
  totalCount: number
  initialPage: number
  initialSort: string
  initialOrder: 'asc' | 'desc'
}) {
  'use client'
  
  const { useQueryStates, parseAsInteger, parseAsString, parseAsStringLiteral } = require('nuqs')
  
  const [page, setPage] = useQueryStates({
    page: parseAsInteger.withDefault(1),
    sort: parseAsString.withDefault('amount'),
    order: parseAsStringLiteral(['asc', 'desc'] as const).withDefault('desc'),
  })
  
  const pagination: PaginationState = {
    pageIndex: (page.page || 1) - 1,
    pageSize: 20,
  }
  
  const sorting: SortingState = [{
    id: page.sort || 'amount',
    desc: (page.order || 'desc') === 'desc',
  }]
  
  return (
    <DataTable
      data={data}
      pageCount={pageCount}
      rowCount={totalCount}
      pagination={pagination}
      sorting={sorting}
      onPaginationChange={(newPagination) => {
        setPage({ page: newPagination.pageIndex + 1 })
      }}
      onSortingChange={(newSorting) => {
        const sort = newSorting[0]
        setPage({ 
          sort: sort?.id || 'amount',
          order: sort?.desc ? 'desc' : 'asc',
          page: 1 
        })
      }}
    />
  )
}

type PageProps = {
  searchParams: Promise<Record<string, string | string[] | undefined>>
}

export default async function Home({ searchParams }: PageProps) {
  const params = await loadDashboardParams(searchParams)
  
  let lastUpdated: Date | null = null
  let error: string | null = null

  try {
    const lastUpdatedData = await fetchLastUpdated()
    lastUpdated = lastUpdatedData ? new Date(lastUpdatedData) : null
  } catch (e) {
    console.error('Failed to fetch last updated:', e)
  }

  let searchResult
  try {
    searchResult = await searchProjects({
      query: params.q,
      state: params.state,
      agency: params.agency,
      category: params.category,
      page: params.page,
      pageSize: 20,
      sort: params.sort,
      order: params.order,
    })
  } catch (e) {
    console.error('Failed to search projects:', e)
    error = 'Unable to load project data. Please try again later.'
  }

  return (
    <main className="min-h-screen p-4 md:p-8">
      <div className="max-w-7xl mx-auto">
        <header className="mb-6">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div>
              <h1 className="text-3xl md:text-4xl font-bold mb-2">Federal Funding Dashboard</h1>
              <p className="text-gray-600">
                Track IIJA infrastructure funding and procedural compliance
              </p>
            </div>
            <Link 
              href="/methodology" 
              className="text-sm text-blue-600 hover:text-blue-800 underline whitespace-nowrap"
            >
              Scoring Methodology
            </Link>
          </div>
          <DataCurrencyBadge 
            lastUpdated={lastUpdated} 
            isLoading={false}
            error={error}
          />
        </header>

        {/* Summary Metrics */}
        {searchResult && (
          <div className="mb-6">
            <DashboardMetrics metrics={searchResult.metrics} />
          </div>
        )}

        {error ? (
          <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">
            {error}
          </div>
        ) : !searchResult || searchResult.data.length === 0 ? (
          <div className="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
            <p className="text-gray-600">
              {params.q || params.state || params.agency || params.category
                ? 'No projects match your filters. Try adjusting your search criteria.'
                : 'No award data available at this time.'}
            </p>
          </div>
        ) : (
          <div className="flex flex-col lg:flex-row gap-6">
            {/* Filter Sidebar - Desktop */}
            <div className="hidden lg:block w-64 flex-shrink-0">
              <div className="sticky top-4">
                <FilterSidebar />
              </div>
            </div>
            
            {/* Mobile Filter Toggle */}
            <div className="lg:hidden mb-4">
              <details className="bg-gray-50 rounded-lg">
                <summary className="p-3 cursor-pointer font-medium text-gray-700">
                  Filters
                  {params.q || params.state || params.agency || params.category ? ' (active)' : ''}
                </summary>
                <div className="p-3 pt-0">
                  <FilterSidebar />
                </div>
              </details>
            </div>
            
            {/* Data Table */}
            <div className="flex-1 min-w-0">
              <TableWrapper
                data={searchResult.data}
                pageCount={searchResult.pagination.pageCount}
                totalCount={searchResult.pagination.totalCount}
                initialPage={params.page}
                initialSort={params.sort}
                initialOrder={params.order}
              />
            </div>
          </div>
        )}
      </div>
    </main>
  )
}
```

This implementation:
- Uses loadDashboardParams for server-side param parsing
- Calls searchProjects with all filter/sort/pagination params
- Includes both desktop (sidebar) and mobile (collapsible) filter layouts
- Maintains existing DataCurrencyBadge and methodology link
- Shows summary metrics above the table
</action>
  <verify>npx tsc --noEmit src/app/page.tsx</verify>
  <done>Dashboard page compiles, uses loadDashboardParams, calls searchProjects, renders DataTable and FilterSidebar</done>
</task>

</tasks>

<verification>
- [ ] DataTable component compiles with TanStack Table patterns
- [ ] FilterSidebar uses nuqs useQueryStates for all filters
- [ ] Dashboard page integrates all components
- [ ] Server-side params flow to searchProjects
- [ ] Mobile filter toggle works (collapsible details element)
</verification>

<success_criteria>
- Data table displays awards with pagination controls
- Filters update URL and trigger re-fetch
- Sorting works via column headers (server-side)
- Mobile layout shows collapsible filters
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-search/03-02-SUMMARY.md`
</output>
