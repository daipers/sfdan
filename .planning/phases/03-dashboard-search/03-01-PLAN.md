---
phase: 03-dashboard-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/search-params.ts
  - src/lib/api.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "URL params define search state (query, filters, page, sort)"
    - "URL state is type-safe and synced across components"
    - "Server can query USASpending API with filters and pagination"
  artifacts:
    - path: "src/lib/search-params.ts"
      provides: "Type-safe URL state management"
      exports: ["dashboardSearchParams", "loadDashboardParams"]
    - path: "src/lib/api.ts"
      provides: "Server-side search with filters/pagination"
      exports: ["searchProjects"]
    - path: "package.json"
      contains: "@tanstack/react-table"
      contains: "nuqs"
  key_links:
    - from: "URL params"
      to: "searchProjects()"
      via: "nuqs loadDashboardParams"
      pattern: "loadDashboardParams.*searchParams"
    - from: "searchProjects()"
      to: "USASpending API"
      via: "fetch with filters"
      pattern: "USASPENDING_API_BASE.*search"
---

<objective>
Set up core infrastructure for dashboard search: install dependencies, create type-safe URL state management, and build server-side search API layer.

Purpose: Enable the dashboard to manage filter/search/sort state via URL and query USASpending API with proper pagination.
Output: Working nuqs integration + server-side search function
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dashboard-search/03-RESEARCH.md
@.planning/phases/02-scoring/02-scoring-01-SUMMARY.md
@src/lib/usaspending.ts
@src/lib/scoring.ts
</context>

<tasks>

<task type="auto">
  <name>Install dashboard dependencies</name>
  <files>package.json</files>
  <action>
Install the required packages for dashboard functionality:

```bash
npm install @tanstack/react-table nuqs @tremor/react recharts
```

These packages provide:
- @tanstack/react-table: Data table with manual pagination/sorting
- nuqs: Type-safe URL state management (v2 with Next.js 15 support)
- @tremor/react: KPI cards and dashboard components
- recharts: Tremor dependency for charts

Do NOT install additional packages beyond these four.
</action>
  <verify>npm ls @tanstack/react-table nuqs @tremor/react recharts</verify>
  <done>All four packages installed and listed in package.json dependencies</done>
</task>

<task type="auto">
  <name>Create type-safe URL state management</name>
  <files>src/lib/search-params.ts</files>
  <action>
Create nuqs search parameter schema for dashboard filters. Use nuqs v2 patterns:

```typescript
// src/lib/search-params.ts
import { createLoader, parseAsInteger, parseAsString, parseAsStringLiteral } from 'nuqs/server'

// Project categories for IIJA
export const PROJECT_CATEGORIES = ['transportation', 'broadband', 'clean_energy', 'water', 'other'] as const

// Federal agencies
export const FEDERAL_AGENCIES = ['DOT', 'DOE', 'EPA', 'HUD', 'USDA'] as const

// US States (abbreviated list for filter)
export const US_STATES = ['AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA', 'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD', 'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ', 'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'] as const

export const dashboardSearchParams = {
  // Search query (debounced in client component)
  q: parseAsString.withDefault(''),
  
  // Pagination
  page: parseAsInteger.withDefault(1),
  
  // Filters
  state: parseAsString,
  agency: parseAsString,
  category: parseAsStringLiteral(PROJECT_CATEGORIES),
  
  // Sorting
  sort: parseAsString.withDefault('amount'),
  order: parseAsStringLiteral(['asc', 'desc'] as const).withDefault('desc'),
}

// Server-side loader for page.tsx
export const loadDashboardParams = createLoader(dashboardSearchParams)
```

Key patterns:
- Use nuqs/server imports for v2 compatibility
- Provide default values for all params
- Export loadDashboardParams for server component use
- Keep state/agency/category as optional strings (null when not set)
</action>
  <verify>npx tsc --noEmit src/lib/search-params.ts</verify>
  <done>Type-safe search params schema with loadDashboardParams export compiles without errors</done>
</task>

<task type="auto">
  <name>Create server-side search API function</name>
  <files>src/lib/api.ts</files>
  <action>
Create a server-side search function that queries USASpending API with filters, pagination, and sorting. This wraps the existing fetchAwards with enhanced filtering.

```typescript
// src/lib/api.ts
import { fetchAwards, AwardSearchResult } from './usaspending'
import { PROJECT_CATEGORIES, FEDERAL_AGENCIES } from './search-params'

export interface SearchParams {
  query?: string
  state?: string | null
  agency?: string | null
  category?: string | null
  page: number
  pageSize?: number
  sort: string
  order: 'asc' | 'desc'
}

export interface SearchResult {
  data: any[]
  pagination: {
    page: number
    pageSize: number
    totalCount: number
    pageCount: number
  }
  metrics: {
    totalSpending: number
    projectCount: number
    avgScore: number
  }
}

/**
 * Server-side search function for dashboard
 * Queries USASpending API with filters, pagination, and sorting
 */
export async function searchProjects(params: SearchParams): Promise<SearchResult> {
  const { query, state, agency, category, page, pageSize = 20, sort, order } = params
  
  // Map agency codes to full names for USASpending API
  const agencyMap: Record<string, string> = {
    'DOT': 'Department of Transportation',
    'DOE': 'Department of Energy',
    'EPA': 'Environmental Protection Agency',
    'HUD': 'Department of Housing and Urban Development',
    'USDA': 'Department of Agriculture',
  }
  
  // Build agency filter if specified
  const agencies = agency ? [agencyMap[agency] || agency] : undefined
  
  // Fetch from USASpending API
  const result = await fetchAwards({
    agencies,
    page,
    pageSize,
  })
  
  // Client-side filtering (USASpending API has limited filter support)
  let filteredResults = result.results || []
  
  // Filter by search query (keyword search in description/recipient)
  if (query) {
    const q = query.toLowerCase()
    filteredResults = filteredResults.filter((award: any) => {
      const desc = (award['Description'] || '').toLowerCase()
      const recipient = (award['Recipient Name'] || '').toLowerCase()
      const awardId = (award['Award ID'] || '').toLowerCase()
      return desc.includes(q) || recipient.includes(q) || awardId.includes(q)
    })
  }
  
  // Filter by state (if available in award data)
  if (state) {
    // Note: USASpending may not have state in all results
    // This is a placeholder - actual implementation depends on API response structure
    filteredResults = filteredResults.filter((award: any) => {
      const popState = award['Place of Performance State'] || award['recipient_state']
      return popState === state
    })
  }
  
  // Filter by category (keyword-based classification)
  if (category) {
    const categoryKeywords: Record<string, string[]> = {
      'transportation': ['highway', 'bridge', 'road', 'transit', 'rail', 'airport', 'port'],
      'broadband': ['broadband', 'internet', 'fiber', 'connectivity', 'digital'],
      'clean_energy': ['energy', 'solar', 'wind', 'renewable', 'grid', 'battery', 'electric'],
      'water': ['water', 'sewer', 'wastewater', 'storm', 'drainage'],
      'other': [],
    }
    
    const keywords = categoryKeywords[category] || []
    if (keywords.length > 0) {
      filteredResults = filteredResults.filter((award: any) => {
        const desc = (award['Description'] || '').toLowerCase()
        return keywords.some(kw => desc.includes(kw))
      })
    }
  }
  
  // Sort results
  const sortFieldMap: Record<string, string> = {
    'amount': 'Award Amount',
    'date': 'Start Date',
    'score': 'score.total',
  }
  
  const sortField = sortFieldMap[sort] || 'Award Amount'
  
  filteredResults.sort((a: any, b: any) => {
    let aVal: any, bVal: any
    
    if (sortField === 'score.total') {
      aVal = a.score?.total ?? 0
      bVal = b.score?.total ?? 0
    } else {
      aVal = a[sortField] ?? 0
      bVal = b[sortField] ?? 0
    }
    
    // Handle dates
    if (sortField === 'Start Date') {
      aVal = aVal ? new Date(aVal).getTime() : 0
      bVal = bVal ? new Date(bVal).getTime() : 0
    }
    
    if (order === 'asc') {
      return aVal > bVal ? 1 : -1
    }
    return aVal < bVal ? 1 : -1
  })
  
  // Calculate metrics from all filtered results
  const totalCount = filteredResults.length
  const totalSpending = filteredResults.reduce((sum: number, a: any) => sum + (a['Award Amount'] || 0), 0)
  const avgScore = filteredResults.reduce((sum: number, a: any) => sum + (a.score?.total ?? 0), 0) / Math.max(totalCount, 1)
  
  // Apply pagination after filtering and sorting
  const pageCount = Math.ceil(totalCount / pageSize)
  const startIndex = (page - 1) * pageSize
  const paginatedData = filteredResults.slice(startIndex, startIndex + pageSize)
  
  return {
    data: paginatedData,
    pagination: {
      page,
      pageSize,
      totalCount,
      pageCount,
    },
    metrics: {
      totalSpending,
      projectCount: totalCount,
      avgScore: Math.round(avgScore),
    },
  }
}
```

This implementation:
- Wraps existing fetchAwards with enhanced filtering
- Performs client-side filtering (USASpending API has limited filter support)
- Supports keyword search across description/recipient/award ID
- Handles sorting by amount, date, or score
- Calculates summary metrics
- Returns paginated results with metadata
</action>
  <verify>npx tsc --noEmit src/lib/api.ts</verify>
  <done>searchProjects function compiles, exports SearchResult interface, and uses existing fetchAwards</done>
</task>

</tasks>

<verification>
- [ ] All four packages installed (npm ls shows versions)
- [ ] search-params.ts compiles without TypeScript errors
- [ ] api.ts compiles without TypeScript errors
- [ ] api.ts imports from usaspending.ts correctly
- [ ] searchProjects returns proper SearchResult structure
</verification>

<success_criteria>
- Dependencies installed and package.json updated
- Type-safe URL state management with nuqs working
- Server-side search function handles filters, pagination, sorting, and metrics
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard-search/03-01-SUMMARY.md`
</output>
