---
phase: 15-production-hardening-automation
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/app/auth/callback/page.tsx
  - playwright.config.ts
  - tests/auth.setup.ts
  - tests/gated-content.spec.ts
autonomous: true

must_haves:
  truths:
    - "Users are logged in after clicking a magic-link on the static site"
    - "Gated content redirects work correctly on GitHub Pages"
    - "E2E tests pass for the gated content journey using auth mocks"
  artifacts:
    - path: "src/app/auth/callback/page.tsx"
      provides: "Client-side auth session handler"
    - path: "tests/auth.setup.ts"
      provides: "E2E auth session mock"
    - path: "tests/gated-content.spec.ts"
      provides: "E2E verification of gated journeys"
  key_links:
    - from: "src/app/auth/callback/page.tsx"
      to: "supabase.auth.getSession()"
      via: "supabase-browser client"
    - from: "tests/gated-content.spec.ts"
      to: "gated-reports"
      via: "mocked auth state"
---

<objective>
Implement a robust client-side authentication callback for static hosting and verify the end-to-end journey for gated content using Playwright mocks. This ensures the dashboard's lead generation and gated reporting work seamlessly on GitHub Pages.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/milestones/v1.0-phases/15-production-hardening-automation/15-RESEARCH.md
@src/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Client-side Auth Callback Page</name>
  <files>
    - src/app/auth/callback/page.tsx
  </files>
  <action>
    - Implement a client-side `AuthCallback` component.
    - Use `useEffect` to call `supabase.auth.getSession()` on mount.
    - Handle the redirect back to the intended destination or the root path once the session is established.
    - Use `router.push('/')` or `router.replace('/')` to minimize browser history clutter.
    - Display a loading indicator while processing the auth session.
  </action>
  <verify>
    Run `npm run dev` and navigate to `/auth/callback` manually (or via magic link test). Verify it processes and redirects.
  </verify>
  <done>
    Auth sessions are correctly handled via a dedicated client route on the static host.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Playwright for Auth Mocks</name>
  <files>
    - playwright.config.ts
    - tests/auth.setup.ts
  </files>
  <action>
    - Set up a Playwright global setup file `tests/auth.setup.ts`.
    - Implement a mechanism to inject a mock Supabase auth session into `localStorage`.
    - Use `page.addInitScript` or direct `page.evaluate` to populate the `sb-[project-id]-auth-token` key.
    - Update `playwright.config.ts` to use this setup for tests that require authentication.
  </action>
  <verify>
    Run a simple test that checks `supabase.auth.getSession()` and verify it returns a session without manual login.
  </verify>
  <done>
    E2E testing environment supports authenticated states without real magic link clicks.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Gated Content E2E Verification</name>
  <files>
    - tests/gated-content.spec.ts
  </files>
  <action>
    - Create a Playwright test file `tests/gated-content.spec.ts`.
    - Test the full journey: 
      - Anonymous user visiting a gated report -> redirected or shown lead capture.
      - Authenticated user visiting the same page -> accesses content successfully.
    - Verify that no `/api` errors occur during the process.
    - Check for correct metadata and analytics events during the journey.
  </action>
  <verify>
    Run `npx playwright test tests/gated-content.spec.ts`.
  </verify>
  <done>
    Critical lead generation and gated content journeys are verified for production.
  </done>
</task>

</tasks>

<verification>
- Run Playwright E2E tests and ensure they pass.
- Manually verify magic link login on the static host (checkpoint:human-verify).
</verification>

<success_criteria>
- Click magic link -> redirected back to site -> user logged in.
- Access gated content as logged-in user -> content visible.
- Access gated content as anonymous user -> lead form visible.
- E2E tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/15-production-hardening-automation/15-03-SUMMARY.md`
</output>
