---
phase: 15-production-hardening-automation
plan: 03
type: execute
wave: 3
depends_on: ["15-02"]
files_modified:
  - package.json
  - scripts/generate-insights.ts
  - .github/workflows/generate-insights.yml
autonomous: true
user_setup:
  - service: GitHub Actions
    why: "Scheduled insight generation"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Project Settings -> API"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Project Settings -> API (Secret Key)"

must_haves:
  truths:
    - "New insights appear in the database weekly without manual action"
    - "Standalone script generates data correctly using USASpending data"
    - "Automation script handles Service Role authentication securely"
  artifacts:
    - path: "scripts/generate-insights.ts"
      provides: "Stand-alone automation script"
    - path: ".github/workflows/generate-insights.yml"
      provides: "Scheduled GitHub Action"
    - path: "package.json"
      provides: "Required dependencies"
  key_links:
    - from: "scripts/generate-insights.ts"
      to: "USASpending API"
      via: "fetchAwards in usaspending.ts"
    - from: "scripts/generate-insights.ts"
      to: "supabase.from('insights').upsert()"
      via: "service_role client"
---

<objective>
Automate the weekly generation of data-driven insights using a standalone script and a scheduled GitHub Action. This keeps the dashboard content fresh without manual intervention or a persistent backend.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/milestones/v1.0-phases/15-production-hardening-automation/15-RESEARCH.md
@src/lib/insights.ts
@src/lib/usaspending.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Setup script dependencies and generate insights</name>
  <files>
    - package.json
    - scripts/generate-insights.ts
  </files>
  <action>
    - **package.json**: Add `tsx` as a devDependency (`npm install --save-dev tsx`).
    - Initialize `scripts/` directory if missing.
    - **generate-insights.ts**:
      - Import `createClient` from `@supabase/supabase-js`.
      - Import `fetchAwards` from `@/lib/usaspending` and `generateInsights` from `@/lib/insights`.
      - Configure the Supabase client using `NEXT_PUBLIC_SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` from `process.env`.
      - Use `fetchAwards` for IIJA projects (pageSize 100+).
      - Use `generateInsights` to create insight objects.
      - Use `supabase.from('insights').upsert(insights, { onConflict: 'fingerprint' })` to store results.
      - Handle missing environment variables gracefully.
  </action>
  <verify>
    Run `npx tsx scripts/generate-insights.ts` locally with Service Role environment variables set. Check the `insights` table for new entries.
  </verify>
  <done>
    Insights can be generated and uploaded to Supabase via a standalone script.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Scheduled GitHub Action</name>
  <files>
    - .github/workflows/generate-insights.yml
  </files>
  <action>
    - Create `.github/workflows/generate-insights.yml`.
    - Set up a `schedule` trigger for Mondays at 08:00 UTC (`cron: '0 8 * * 1'`).
    - Add a `workflow_dispatch` trigger for manual runs.
    - Workflow steps:
      - Checkout repo.
      - Setup Node.js.
      - Install dependencies (`npm install`).
      - Run script: `npx tsx scripts/generate-insights.ts`.
    - Inject secrets: `NEXT_PUBLIC_SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`.
  </action>
  <verify>
    Commit and push (or use `gh workflow run`) to trigger the action manually. Verify it completes successfully in the GitHub Actions dashboard.
  </verify>
  <done>
    Weekly insights generation is automated and monitored via GitHub Actions.
  </done>
</task>

</tasks>

<verification>
- Manually trigger GitHub Action and verify success.
- Check Supabase `insights` table for updated entries.
</verification>

<success_criteria>
- Insights script runs successfully.
- No duplicate insights appear due to fingerprint conflicts.
- GitHub Action runs on schedule or manual trigger.
</success_criteria>

<output>
After completion, create `.planning/phases/15-production-hardening-automation/15-03-SUMMARY.md`
</output>
