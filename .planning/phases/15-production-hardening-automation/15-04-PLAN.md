---
phase: 15-production-hardening-automation
plan: 04
type: execute
wave: 3
depends_on: ["15-01", "15-02"]
files_modified:
  - src/app/auth/callback/page.tsx
  - src/app/content/[slug]/page.tsx
  - tests/auth.setup.ts
  - tests/gated-content.spec.ts
autonomous: true

must_haves:
  truths:
    - "Users are logged in after clicking a magic-link on the static site"
    - "Auth callback restores original user context after sign-in"
    - "Gated content 'unlocks' dynamically on the client"
    - "E2E tests pass for gated content journey"
  artifacts:
    - path: "src/app/auth/callback/page.tsx"
      provides: "Redirect-aware auth session handler"
    - path: "src/app/content/[slug]/page.tsx"
      provides: "Client-side gating re-hydration"
    - path: "tests/auth.setup.ts"
      provides: "E2E auth session mock"
    - path: "tests/gated-content.spec.ts"
      provides: "E2E verification of gated journeys"
  key_links:
    - from: "src/app/auth/callback/page.tsx"
      to: "searchParams.get('redirectTo')"
      via: "context restoration"
    - from: "src/app/content/[slug]/page.tsx"
      to: "supabase.auth.onAuthStateChange()"
      via: "client-side unlocking"
---

<objective>
Implement a redirect-aware client-side authentication callback and dynamic content gating for the statically hosted site. Verify the full user journey with Playwright E2E tests.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/milestones/v1.0-phases/15-production-hardening-automation/15-RESEARCH.md
@src/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auth Callback and Context Restoration</name>
  <files>
    - src/app/auth/callback/page.tsx
  </files>
  <action>
    - Implement a client-side `AuthCallback` component.
    - Use `useEffect` to call `supabase.auth.getSession()` on mount.
    - Retrieve the `redirectTo` query parameter from the URL using `useSearchParams`.
    - If `redirectTo` exists, use `router.push(redirectTo)` after the session is established.
    - Default to `router.push('/')` if no redirect context is provided.
    - Display a loading indicator while processing.
  </action>
  <verify>
    Navigate to `/auth/callback?redirectTo=/content/test-report` manually and verify it redirects after processing (simulate session if needed).
  </verify>
  <done>
    Auth sessions are handled and users are returned to their original destination.
  </done>
</task>

<task type="auto">
  <name>Task 2: Client-side Gating and Re-hydration</name>
  <files>
    - src/app/content/[slug]/page.tsx
  </files>
  <action>
    - Update the component to handle auth state on the client (since static build is always gated).
    - Add `useEffect` to check `supabase.auth.getSession()` on mount.
    - Subscribe to `supabase.auth.onAuthStateChange()` to handle real-time login.
    - Use local state (`isUnlocked`) to dynamically reveal content when a session exists.
    - Ensure smooth UI transitions between "gated" and "unlocked" states.
  </action>
  <verify>
    Load a gated report as anonymous, then sign in (e.g. via dev console simulation) and verify content appears.
  </verify>
  <done>
    Gated content correctly unlocks on the client based on auth session.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement E2E Verification</name>
  <files>
    - tests/auth.setup.ts
    - tests/gated-content.spec.ts
  </files>
  <action>
    - **auth.setup.ts**: Implement logic to inject a mock Supabase session into `localStorage`. This allows tests to run as "authenticated" without real magic links.
    - **gated-content.spec.ts**:
      - Test anonymous access to a gated report -> shown lead capture form.
      - Test authenticated access -> accesses full content.
      - Verify no `/api` errors occur during navigation.
      - Verify analytics events are triggered correctly during the journey.
  </action>
  <verify>
    Run `npx playwright test`.
  </verify>
  <done>
    Full gated content journey is verified for production deployment.
  </done>
</task>

</tasks>

<verification>
- Magic link login restores user to original gated report.
- E2E tests pass for authenticated and anonymous scenarios.
- No `/api` dependencies remain for gating/auth.
</verification>

<success_criteria>
- Click magic link from report page -> redirected back to the same report page -> content unlocked.
- E2E tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/15-production-hardening-automation/15-04-SUMMARY.md`
</output>
