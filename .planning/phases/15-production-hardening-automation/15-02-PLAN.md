---
phase: 15-production-hardening-automation
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/components/AdminInsightsTable.tsx
  - supabase/schema.sql
autonomous: true

must_haves:
  truths:
    - "Admin insights approval works via direct client-side update()"
    - "Service role can 'upsert' insights without permission errors"
    - "Authenticated admins have UPDATE permission for 'insights' table"
  artifacts:
    - path: "src/components/AdminInsightsTable.tsx"
      provides: "Direct admin management"
    - path: "supabase/schema.sql"
      provides: "Enhanced security policies"
  key_links:
    - from: "src/components/AdminInsightsTable.tsx"
      to: "supabase.from('insights').update()"
      via: "admin authentication"
    - from: "service_role"
      to: "insights"
      via: "INSERT, UPDATE"
---

<objective>
Harden administrative features and back-end permissions to support direct client-side updates and secure automated data ingestion.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Admin Insights and RLS</name>
  <files>
    - src/components/AdminInsightsTable.tsx
    - supabase/schema.sql
  </files>
  <action>
    - **AdminInsightsTable**: Update approval/rejection logic to use `supabase.from('insights').update({ status }).match({ id })` using the browser client.
    - **RLS**: In `supabase/schema.sql`, add an `UPDATE` policy for the `insights` table allowing `authenticated` users (admins) to modify records.
    - Example: `CREATE POLICY "Allow auth update" ON insights FOR UPDATE TO authenticated USING (true);`.
    - Also ensure `SELECT` is allowed for authenticated users.
    - Remove `fetch('/api/insights/approve')` calls.
  </action>
  <verify>
    Log in as admin and test approving an insight in the UI. Check `insights` table for status change.
  </verify>
  <done>
    Admin insights management is client-side and secured by RLS.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Service Role Permissions for Automation</name>
  <files>
    - supabase/schema.sql
  </files>
  <action>
    - Grant `ALL` permissions (or at least `INSERT` and `UPDATE`) to the `service_role` for the `insights` table. This is required for the `upsert` operation in the automated script.
    - In `supabase/schema.sql`: `GRANT ALL ON TABLE insights TO service_role;` (if standard SQL) or update existing grants.
    - Note: In Supabase, the `service_role` usually bypasses RLS, but explicit SQL grants for `INSERT, UPDATE` may be needed for certain upsert conflict resolutions if not already present.
  </action>
  <verify>
    Check Supabase dashboard for `service_role` permissions on the `insights` table.
  </verify>
  <done>
    Service role can successfully upsert records into the 'insights' table.
  </done>
</task>

</tasks>

<verification>
- Admin can update status of insights without 403 Forbidden errors.
- Service role has necessary permissions for upsert operations.
</verification>

<success_criteria>
- Admin status update -> successful DB record change.
- RLS policies for authenticated users are correctly applied.
</success_criteria>

<output>
After completion, create `.planning/phases/15-production-hardening-automation/15-02-SUMMARY.md`
</output>
