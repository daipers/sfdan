---
phase: 15-production-hardening-automation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/generate-insights.ts
  - .github/workflows/generate-insights.yml
autonomous: true
user_setup:
  - service: GitHub Actions
    why: "Scheduled insight generation"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Project Settings -> API"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Project Settings -> API (Secret Key)"

must_haves:
  truths:
    - "New insights appear in the database weekly without manual action"
    - "Standalone scripts generate data correctly using USASpending data"
    - "Automation script handles Service Role authentication securely"
  artifacts:
    - path: "scripts/generate-insights.ts"
      provides: "Stand-alone automation script"
    - path: ".github/workflows/generate-insights.yml"
      provides: "Scheduled GitHub Action"
  key_links:
    - from: "scripts/generate-insights.ts"
      to: "USASpending API"
      via: "fetchAwards in usaspending.ts"
    - from: "scripts/generate-insights.ts"
      to: "supabase.from('insights')"
      via: "supabase-js Service Role client"
---

<objective>
Automate the generation of data-driven insights to keep content fresh without a persistent backend server. This uses a scheduled GitHub Action and a standalone TypeScript script.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/milestones/v1.0-phases/15-production-hardening-automation/15-RESEARCH.md
@src/lib/insights.ts
@src/lib/usaspending.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Standalone Insights Generation Script</name>
  <files>
    - scripts/generate-insights.ts
  </files>
  <action>
    - Initialize `scripts/` directory if it doesn't exist.
    - Create `generate-insights.ts`.
    - Use `fetchAwards` from `@/lib/usaspending` to get recent IIJA projects (page size 100+).
    - Use `generateInsights` from `@/lib/insights` to create insight drafts.
    - Use the Supabase Service Role client (configured via `SUPABASE_SERVICE_ROLE_KEY`) to `upsert` these insights into the `insights` table.
    - Use `fingerprint` for `onConflict` resolution to avoid duplicates.
    - Ensure it handles missing environment variables gracefully.
  </action>
  <verify>
    Run `npx tsx scripts/generate-insights.ts` locally with Service Role environment variables set. Check the `insights` table for new entries.
  </verify>
  <done>
    Insights can be generated and uploaded to Supabase via a standalone script.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Scheduled GitHub Action</name>
  <files>
    - .github/workflows/generate-insights.yml
  </files>
  <action>
    - Create the `.github/workflows/generate-insights.yml` file.
    - Set up a `schedule` trigger for Mondays at 08:00 UTC (`cron: '0 8 * * 1'`).
    - Add a `workflow_dispatch` trigger for manual runs.
    - Configure the job to:
      - Checkout the repository.
      - Install dependencies using `npm install`.
      - Run the script: `npx tsx scripts/generate-insights.ts`.
    - Provide necessary secrets: `NEXT_PUBLIC_SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`.
  </action>
  <verify>
    Commit and push (or use `gh workflow run`) to trigger the action manually in GitHub Actions UI. Verify it completes successfully.
  </verify>
  <done>
    Weekly insights generation is automated and monitored via GitHub Actions.
  </done>
</task>

</tasks>

<verification>
- Manually trigger the GitHub Action and verify it completes without errors.
- Check the `insights` table in Supabase for updated entries.
</verification>

<success_criteria>
- Insights script runs -> record in DB.
- GitHub Action triggered -> script runs successfully.
- No duplicate insights appear due to fingerprint conflicts.
</success_criteria>

<output>
After completion, create `.planning/phases/15-production-hardening-automation/15-02-SUMMARY.md`
</output>
