---
phase: 15-production-hardening-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/NewsletterSignupForm.tsx
  - src/components/EmailGateForm.tsx
  - src/app/content/page.tsx
  - src/components/AdminInsightsTable.tsx
  - src/lib/analytics.ts
  - supabase/schema.sql
autonomous: true

must_haves:
  truths:
    - "Newsletter signup works without a backend API route"
    - "Lead capture works without a backend API route"
    - "Insights library list loads without a backend API route"
    - "Admin insights approval works without a backend API route"
    - "Analytics events are recorded directly to Supabase from the browser"
    - "Public (anon) users can insert data but not read sensitive fields"
  artifacts:
    - path: "src/components/NewsletterSignupForm.tsx"
      provides: "Client-side subscription"
    - path: "src/components/EmailGateForm.tsx"
      provides: "Client-side lead capture"
    - path: "src/app/content/page.tsx"
      provides: "Client-side content list"
    - path: "src/components/AdminInsightsTable.tsx"
      provides: "Client-side admin approval"
    - path: "src/lib/analytics.ts"
      provides: "Client-side event tracking"
    - path: "supabase/schema.sql"
      provides: "RLS security policies"
  key_links:
    - from: "src/app/content/page.tsx"
      to: "supabase.from('content_posts')"
      via: "supabase-browser client"
    - from: "src/components/AdminInsightsTable.tsx"
      to: "supabase.from('insights')"
      via: "supabase-browser client"
    - from: "src/components/NewsletterSignupForm.tsx"
      to: "supabase.from('newsletter_subscriptions')"
      via: "supabase-browser client"
    - from: "src/lib/analytics.ts"
      to: "supabase.from('analytics_events')"
      via: "supabase-browser client"
---

<objective>
Transition user-facing dynamic features from server-side API routes to direct client-side Supabase interactions. This ensures they function correctly on a static host (GitHub Pages) and minimizes backend dependency.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/milestones/v1.0-phases/15-production-hardening-automation/15-RESEARCH.md
@src/lib/supabase.ts
@src/lib/analytics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Forms and Content Library to Client-side Supabase</name>
  <files>
    - src/components/NewsletterSignupForm.tsx
    - src/components/EmailGateForm.tsx
    - src/app/content/page.tsx
    - src/components/AdminInsightsTable.tsx
  </files>
  <action>
    - Import `createClient` from `@/lib/supabase` (the browser client).
    - Update `NewsletterSignupForm` and `EmailGateForm` `handleSubmit` functions to use `supabase.from('newsletter_subscriptions').insert()` and `supabase.from('leads').insert()` respectively.
    - Update `src/app/content/page.tsx` to fetch content library items directly from `content_posts` using the browser client instead of `fetch('/api/content')`.
    - Update `src/components/AdminInsightsTable.tsx` to approve/reject insights directly via `supabase.from('insights').update()` instead of `fetch('/api/insights/approve')`.
    - Remove corresponding `fetch('/api/...')` calls and API route dependencies.
    - Ensure error handling displays user-friendly messages from the Supabase response.
    - Maintain existing UI state (loading, success, error).
  </action>
  <verify>
    Run `npm run dev` and test form submissions, content library loading, and admin approval actions. Verify data changes in the local Supabase instance.
  </verify>
  <done>
    Forms and content management components interact directly with Supabase using the browser client.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor Analytics to Client-side</name>
  <files>
    - src/lib/analytics.ts
  </files>
  <action>
    - Update `trackEvent` to use the browser `createClient` from `@/lib/supabase`.
    - Use `supabase.from('analytics_events').insert(payload)` instead of `fetch('/api/analytics')`.
    - Ensure it continues to fail silently to avoid impacting UX.
    - Maintain existing normalization logic for event payloads.
  </action>
  <verify>
    Browse the site in dev mode and check the `analytics_events` table in Supabase for new entries.
  </verify>
  <done>
    Analytics events are stored in Supabase without a backend proxy.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement RLS Policies for Public Inserts</name>
  <files>
    - supabase/schema.sql
  </files>
  <action>
    - Enable Row Level Security (RLS) on `newsletter_subscriptions`, `leads`, and `analytics_events` tables if not already enabled.
    - Add `INSERT` policies for the `anon` role for all three tables.
    - Ensure `SELECT`, `UPDATE`, and `DELETE` are NOT allowed for `anon`.
    - For `newsletter_subscriptions`, use a policy like: `CREATE POLICY "Allow anon insert" ON newsletter_subscriptions FOR INSERT TO anon WITH CHECK (true);`
    - Repeat for `leads` and `analytics_events`.
  </action>
  <verify>
    Use the Supabase SQL editor or CLI to verify policies are active. Test an insert using the anon key via `curl` or browser console.
  </verify>
  <done>
    Tables are secured with RLS, allowing public inserts but preventing unauthorized reads.
  </done>
</task>

</tasks>

<verification>
- Check local Supabase dashboard for data in `newsletter_subscriptions`, `leads`, and `analytics_events` after testing forms/site.
- Verify no `fetch('/api/...')` calls remain for these features in the network tab.
</verification>

<success_criteria>
- Newsletter signup successful -> record in DB.
- Lead capture successful -> record in DB.
- Page navigation -> analytics record in DB.
- All operations happen client-side with no 404/500 API errors.
</success_criteria>

<output>
After completion, create `.planning/phases/15-production-hardening-automation/15-01-SUMMARY.md`
</output>
