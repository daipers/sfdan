---
phase: 15-production-hardening-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/NewsletterSignupForm.tsx
  - src/components/EmailGateForm.tsx
  - src/app/content/page.tsx
  - src/lib/analytics.ts
  - supabase/schema.sql
autonomous: true

must_haves:
  truths:
    - "Newsletter signup works via direct insert to 'newsletter_subscribers'"
    - "Lead capture triggers magic-link auth via signInWithOtp"
    - "Content library loads via direct Supabase query"
    - "Analytics events are recorded directly from the browser"
    - "Public users can insert data but not read sensitive fields"
  artifacts:
    - path: "src/components/NewsletterSignupForm.tsx"
      provides: "Client-side subscription"
    - path: "src/components/EmailGateForm.tsx"
      provides: "Magic-link auth for leads"
    - path: "src/app/content/page.tsx"
      provides: "Client-side content list"
    - path: "src/lib/analytics.ts"
      provides: "Client-side event tracking"
    - path: "supabase/schema.sql"
      provides: "Public RLS policies"
  key_links:
    - from: "src/components/NewsletterSignupForm.tsx"
      to: "supabase.from('newsletter_subscribers')"
      via: "insert()"
    - from: "src/components/EmailGateForm.tsx"
      to: "supabase.auth.signInWithOtp()"
      via: "magic-link authentication"
    - from: "src/lib/analytics.ts"
      to: "supabase.from('analytics_events')"
      via: "insert()"
---

<objective>
Refactor public-facing components to interact directly with Supabase, enabling functionality on static hosts and removing dependence on backend API routes for data ingestion.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/milestones/v1.0-phases/15-production-hardening-automation/15-RESEARCH.md
@src/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Forms (Newsletter & Lead Capture)</name>
  <files>
    - src/components/NewsletterSignupForm.tsx
    - src/components/EmailGateForm.tsx
    - supabase/schema.sql
  </files>
  <action>
    - Import `createClient` from `@/lib/supabase` (browser client).
    - **NewsletterSignupForm**: Update `handleSubmit` to use `supabase.from('newsletter_subscribers').insert({ email })`. (Note: use 'newsletter_subscribers' per schema).
    - **EmailGateForm**: Update `handleSubmit` to call `supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } })` followed by `supabase.from('leads').insert({ email })`. This maintains the magic-link flow (LEAD-02).
    - **RLS**: In `supabase/schema.sql`, enable RLS on `newsletter_subscribers` and `leads`. Add `INSERT` policies for `anon` role: `CREATE POLICY "Allow public insert" ON [table] FOR INSERT TO anon WITH CHECK (true);`.
    - Remove `fetch('/api/newsletter')` and `fetch('/api/leads')` calls.
  </action>
  <verify>
    Test both forms in dev mode. Verify `newsletter_subscribers` and `leads` tables receive data. Verify magic-link email is triggered for leads.
  </verify>
  <done>
    Forms use direct Supabase calls and are protected by RLS.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate Content Library and Analytics</name>
  <files>
    - src/app/content/page.tsx
    - src/lib/analytics.ts
    - supabase/schema.sql
  </files>
  <action>
    - **Content Library**: Update `src/app/content/page.tsx` to fetch `content_posts` directly using `supabase.from('content_posts').select('*')`.
    - **Analytics**: Update `src/lib/analytics.ts` to use `supabase.from('analytics_events').insert(payload)`. Remove `/api/analytics` dependency.
    - **RLS**: Enable RLS on `analytics_events` and add `INSERT` policy for `anon`. Ensure `content_posts` has a `SELECT` policy for `anon` (if public).
  </action>
  <verify>
    Browse content page and verify list loads. Check `analytics_events` table for navigation events.
  </verify>
  <done>
    Content list and analytics use client-side Supabase client.
  </done>
</task>

</tasks>

<verification>
- No `/api` calls for forms, content, or analytics in browser Network tab.
- Data appears in Supabase tables after interaction.
</verification>

<success_criteria>
- Newsletter signup -> record in `newsletter_subscribers`.
- Lead capture -> email triggered + record in `leads`.
- Analytics -> record in `analytics_events`.
</success_criteria>

<output>
After completion, create `.planning/phases/15-production-hardening-automation/15-01-SUMMARY.md`
</output>
