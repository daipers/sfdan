---
phase: 15-production-hardening-automation
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/usaspending.ts
  - src/app/api/agency-stats/route.ts
  - src/lib/content.ts
autonomous: true

must_haves:
  truths:
    - "Homepage loads project data without 'Unable to load project data' error"
    - "Agency comparison charts render data correctly"
    - "Content pages render fallback content when Supabase is disconnected"
  artifacts:
    - path: "src/lib/usaspending.ts"
      provides: "valid award_type_codes group"
      contains: "DEFAULT_AWARD_TYPE_CODES = ['A', 'B', 'C', 'D']"
    - path: "src/app/api/agency-stats/route.ts"
      provides: "valid API limit"
      contains: "pageSize: 100"
    - path: "src/lib/content.ts"
      provides: "graceful fallback for content posts"
      contains: ".limit(1)"
---

<objective>
Resolve runtime data loading failures caused by USASpending API changes and Supabase query constraints.

Purpose: Restore the core functionality of the dashboard (search, metrics, content) which is currently blocked by 422 errors and runtime crashes.
Output: Resilient API client and data fetching logic.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/usaspending.ts
@src/app/api/agency-stats/route.ts
@src/lib/content.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix USASpending API 422 errors</name>
  <files>src/lib/usaspending.ts, src/app/api/agency-stats/route.ts</files>
  <action>
- In `src/lib/usaspending.ts`, update `DEFAULT_AWARD_TYPE_CODES` to `['A', 'B', 'C', 'D']` only. The API has recently disallowed mixing 'Contracts' and 'Grants' in the same search request.
- In `src/app/api/agency-stats/route.ts`, reduce `pageSize` from 500 to 100. The API has recently started enforcing a strict maximum limit of 100 per request.
  </action>
  <verify>
Run `npx playwright test tests/e2e.spec.ts` and verify the dashboard loads without error.
  </verify>
  <done>
USASpending API calls return 200 OK for search and aggregation requests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Supabase static generation errors</name>
  <files>src/lib/content.ts</files>
  <action>
- In `src/lib/content.ts`, replace `.single()` with `.limit(1)` in `getContentBySlug`.
- Update the logic to check `data?.[0]` instead of expecting a single object. This prevents runtime errors during build when content is not found in the development database.
  </action>
  <verify>
Run `npm run build` and ensure no "Cannot coerce the result to a single JSON object" errors occur.
  </verify>
  <done>
Static build completes successfully without Supabase runtime errors.
  </done>
</task>

</tasks>

<verification>
- Homepage loads without error overlay.
- Search/filter functionality works with updated award types.
- Agency stats display data correctly.
- `npm run build` succeeds.
</verification>

<success_criteria>
- No "Unable to load project data" error on homepage.
- No 422 errors in network logs for USASpending API.
- All 30 static pages generated during build.
</success_criteria>

<output>
After completion, create `.planning/phases/15-production-hardening-automation/15-05-SUMMARY.md`
</output>
