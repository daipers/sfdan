---
phase: "04-details-leadgen"
plan: "02"
type: "execute"
wave: 1
depends_on: []
files_modified:
  - "src/app/api/auth/magic-link/route.ts"
  - "src/app/gated-reports/page.tsx"
  - "src/components/EmailGateForm.tsx"
  - "src/components/MagicLinkVerification.tsx"
  - "src/lib/auth.ts"
  - "supabase/schema.sql"
autonomous: false
user_setup:
  - service: supabase
    why: "Email authentication and lead storage"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Settings -> API"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Settings -> API (for admin operations)"
    dashboard_config:
      - task: "Enable magic link authentication"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email"
      - task: "Create leads table"
        location: "Supabase Dashboard -> SQL Editor"
must_haves:
  truths:
    - "Users can enter email to receive magic link"
    - "Magic link authenticates user via Supabase Auth"
    - "Authenticated users can access gated PDF reports"
    - "Leads capture organization and role for follow-up"
    - "Session persists across page refreshes"
  artifacts:
    - path: "src/app/api/auth/magic-link/route.ts"
      provides: "Magic link email sending endpoint"
      exports: "POST handler for email submission"
    - path: "src/app/gated-reports/page.tsx"
      provides: "Protected reports page"
      exports: "Page component with session check"
    - path: "src/components/EmailGateForm.tsx"
      provides: "Email input form with validation"
      exports: "EmailGateForm component"
    - path: "supabase/schema.sql"
      provides: "Leads table schema"
      exports: "CREATE TABLE leads"
  key_links:
    - from: "src/components/EmailGateForm.tsx"
      to: "src/app/api/auth/magic-link/route.ts"
      via: "POST fetch"
      pattern: "fetch.*magic-link"
    - from: "src/app/gated-reports/page.tsx"
      to: "Supabase Auth"
      via: "supabase.auth.getSession"
      pattern: "getSession.*session"
---

<objective>
Implement email-gated lead generation with Supabase Auth magic links and PDF report access.

Purpose: Capture leads (journalists, municipal finance officers) who want detailed procedural audit reports by requiring email registration.
Output: Working email gate with magic link authentication
</objective>

<execution_context>
@./.planning/phases/04-details-leadgen/04-01-PLAN.md
@./.planning/ROADMAP.md
</execution_context>

<context>
@./.planning/PROJECT.md
@./src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Supabase client and auth helpers</name>
  <files>src/lib/supabase.ts</files>
  <action>
    Create Supabase client configuration:
    - Install @supabase/ssr package
    - Create src/lib/supabase.ts with createBrowserClient for client-side
    - Create src/lib/supabase-server.ts with createServerClient for server-side
    - Configure auth options: email magic link enabled, auto-confirm disabled
    - Export auth helpers for session management
  </action>
  <verify>
    npm install @supabase/ssr && npx tsc --noEmit
  </verify>
  <done>
    Supabase client configured and importable
  </done>
</task>

<task type="auto">
  <name>Task 2: Create magic link API endpoint</name>
<files>src/app/api/auth/magic-link/route.ts</files>
<action>
    Create POST endpoint for sending magic links:
    - Accept { email, organization?, role? } in request body
    - Validate email format
    - Call Supabase Auth admin API to generate magic link
    - Store lead info (email, organization, role) in leads table
    - Return success message (don't reveal if email exists for security)
    - Handle errors gracefully with appropriate HTTP status codes
  </action>
  <verify>
    npx tsc --noEmit && curl -X POST http://localhost:3000/api/auth/magic-link -H application/json" - "Content-Type:d '{"email":"test@example.com"}' | grep -q "success"
  </verify>
  <done>
    Magic link endpoint accepts email and returns success
  </done>
</task>

<task type="auto">
<name>Task 3: Create leads table in Supabase</name>
<files>supabase/schema.sql</files>
<action>
    Define and execute SQL for leads table:
    - Table: leads (id, email, organization, role, created_at, updated_at)
    - Enable Row Level Security: users can only read their own record
    - Add index on email for fast lookups
    - Include RLS policies for authenticated users
    - Document SQL for user to run in Supabase dashboard
  </action>
  <verify>
    ls supabase/schema.sql && grep -q "CREATE TABLE.*leads" supabase/schema.sql
  </verify>
  <done>
    Leads table schema defined and documented
  </done>
</task>

<task type="auto">
  <name>Task 4: Create EmailGateForm component</name>
<files>src/components/EmailGateForm.tsx</files>
<action>
    Create email gate form component:
    - Input fields: email (required), organization (optional), role (optional dropdown)
    - Client-side email validation
    - Submit to /api/auth/magic-link endpoint
    - Show loading state during submission
    - Display success message with check-your-email instructions
    - Handle errors with user-friendly messages
    - Style with Tailwind, consistent with dashboard
  </action>
  <verify>
    npx tsc --noEmit && ls src/components/EmailGateForm.tsx
  </verify>
  <done>
    EmailGateForm renders with validation and submission
  </done>
</task>

<task type="auto">
<name>Task 5: Create gated reports page with session check</name>
<files>src/app/gated-reports/page.tsx</files>
<action>
    Create protected reports page:
    - Check for existing Supabase session on mount
    - If no session: show EmailGateForm component
    - If authenticated: show available PDF reports
    - Reports list: include mock report items with download buttons
    - Include sign out button for authenticated users
    - Use server-side session check for initial render, client-side for updates
  </action>
  <verify>
    npx tsc --noEmit && npm run build
  </verify>
  <done>
    Gated reports page shows form or reports based on auth state
  </done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Lead generation system with Supabase Auth magic links</what-built>
  <how-to-verify>
    1. Visit /gated-reports - should show email form
    2. Enter email and click submit - should show success message
    3. Check email for magic link (or Supabase dashboard for test emails)
    4. Click magic link - should redirect to /gated-reports showing reports
    5. Sign out - should return to email form
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] Supabase client configured with @supabase/ssr
- [ ] Magic link API endpoint functional
- [ ] Leads table schema documented
- [ ] EmailGateForm validates and submits
- [ ] Gated reports page shows content based on auth state
- [ ] Checkpoint verification passes
</verification>

<success_criteria>
Users can:
- Enter email to receive magic link
- Authenticate via magic link
- Access gated PDF reports after authentication
- Lead information (email, organization, role) is captured
</success_criteria>

<output>
After completion, create `.planning/phases/04-details-leadgen/04-02-SUMMARY.md`
</output>
