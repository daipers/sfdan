---
phase: 12-runtime-data-errors
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/usaspending.ts
  - src/lib/content.ts
  - src/lib/content-fallback.ts
  - src/app/content/page.tsx
  - src/app/content/[slug]/page.tsx
  - src/app/api/export/route.ts
autonomous: true
user_setup:
  - service: supabase
    why: "Create content_posts so content queries succeed"
    dashboard_config:
      - task: "Run supabase/schema.sql in Supabase SQL Editor"
        location: "Supabase Dashboard -> SQL Editor"

must_haves:
  truths:
    - "Content pages render a fallback list when Supabase content tables are unavailable"
    - "Project detail pages for sample IDs render without USASpending 422 errors"
    - "Static export no longer errors on /api/export during build"
  artifacts:
    - path: "src/lib/usaspending.ts"
      provides: "award-by-id filters include required award_type_codes"
      contains: "award_type_codes"
    - path: "src/lib/content-fallback.ts"
      provides: "fallback content for static export"
      min_lines: 20
    - path: "src/lib/content.ts"
      provides: "graceful handling for missing content_posts"
      contains: "PGRST205"
    - path: "src/app/api/export/route.ts"
      provides: "static-export safe export handler"
      contains: "nextUrl.searchParams"
  key_links:
    - from: "src/app/content/page.tsx"
      to: "src/lib/content.ts"
      via: "getPublishedContent"
      pattern: "getPublishedContent"
    - from: "src/app/content/[slug]/page.tsx"
      to: "src/lib/content.ts"
      via: "getContentBySlug"
      pattern: "getContentBySlug"
    - from: "src/app/projects/[id]/page.tsx"
      to: "src/lib/usaspending.ts"
      via: "fetchAwardById"
      pattern: "fetchAwardById"
---

<objective>
Resolve runtime data errors during static builds by making content queries resilient, fixing USASpending award-by-id filters, and ensuring export routes are static-safe.

Purpose: Ensure the GitHub Pages export completes cleanly and pages render without external-data errors.
Output: Updated USASpending filters, content fallbacks, and static-safe export handler.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/usaspending.ts
@src/lib/content.ts
@src/app/content/page.tsx
@src/app/content/[slug]/page.tsx
@src/app/api/export/route.ts
@supabase/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix award-by-id filters for USASpending</name>
  <files>src/lib/usaspending.ts</files>
  <action>
Add required award filters to fetchAwardById so the USASpending API no longer returns 422. Reuse the same award_type_codes and assistance_type values used in fetchAwards (either by extracting shared constants or duplicating the values near fetchAwardById). Keep existing scoring mapping logic unchanged.
  </action>
  <verify>rg "award_type_codes" src/lib/usaspending.ts</verify>
  <done>fetchAwardById includes award_type_codes (and assistance_type if required) in its filters payload.</done>
</task>

<task type="auto">
  <name>Task 2: Add fallback content for missing content_posts</name>
  <files>src/lib/content.ts, src/lib/content-fallback.ts, src/app/content/page.tsx, src/app/content/[slug]/page.tsx</files>
  <action>
Create a small fallback content list for the three placeholder slugs used in static export. Update getPublishedContent and getContentBySlug to return fallback data when Supabase is not configured or when Supabase responds with the "PGRST205" missing table error. Avoid logging this specific missing-table error as a console.error (use a single console.warn instead), but keep error logging for other failures. Ensure content pages continue to render normally when Supabase is available.
  </action>
  <verify>rg "content-fallback|PGRST205" src/lib/content.ts src/lib/content-fallback.ts</verify>
  <done>Content list and detail pages render with fallback data when content_posts is missing; no missing-table errors are thrown.</done>
</task>

<task type="auto">
  <name>Task 3: Make export route static-export safe</name>
  <files>src/app/api/export/route.ts</files>
  <action>
Avoid using request.url in the export route handler. Use request.nextUrl.searchParams for query parsing and add a STATIC_EXPORT guard that returns a JSON 501 message indicating client-side export should be used on GitHub Pages. Keep the existing export logic for non-static environments.
  </action>
  <verify>rg "nextUrl.searchParams" src/app/api/export/route.ts</verify>
  <done>Static export no longer errors on /api/export, and server export still functions in non-static environments.</done>
</task>

</tasks>

<verification>
- npm run build:static
</verification>

<success_criteria>
- Static export completes without Supabase missing-table or USASpending 422 errors
- Content pages render with fallback data when Supabase content tables are not present
- Project detail sample pages render without USASpending API filter failures
</success_criteria>

<output>
After completion, create `.planning/phases/12-runtime-data-errors/12-01-SUMMARY.md`
</output>
