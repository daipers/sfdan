---
phase: 08-8-functionality-expansion-we-are-going-to-make-sure-it-works-exactly-like-we-want-it-to-we-want-it-completely-functional
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/schema.sql
  - src/app/api/analytics/route.ts
  - src/lib/analytics.ts
autonomous: true
requirements: [HARD-02]
user_setup:
  - service: supabase
    why: "Persist analytics events"
    dashboard_config:
      - task: "Apply analytics_events table + policies from supabase/schema.sql"
        location: "Supabase Dashboard -> SQL Editor"

must_haves:
  truths:
    - "Analytics events can be persisted in Supabase"
    - "Client analytics calls return a 2xx response"
  artifacts:
    - path: "supabase/schema.sql"
      provides: "analytics_events table with RLS policies"
      contains: "analytics_events"
    - path: "src/app/api/analytics/route.ts"
      provides: "POST analytics event endpoint"
      exports: ["POST"]
    - path: "src/lib/analytics.ts"
      provides: "trackEvent helper for client instrumentation"
      exports: ["trackEvent"]
  key_links:
    - from: "src/app/api/analytics/route.ts"
      to: "analytics_events"
      via: "supabase admin insert"
      pattern: "analytics_events"
    - from: "src/lib/analytics.ts"
      to: "/api/analytics"
      via: "fetch"
      pattern: "fetch\\(.*\/api\/analytics"
---

<objective>
Add analytics storage and a logging endpoint so priority journeys can emit metrics.

Purpose: Provide a durable, privacy-conscious analytics pipeline without new vendors.
Output: Analytics table in schema, API endpoint, and client helper.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/schema.sql
@src/app/api/auth/magic-link/route.ts
@src/app/api/newsletter/subscribe/route.ts
</context>

<tasks>

<task type="auto">
  <name>Define analytics_events storage + policies</name>
  <files>supabase/schema.sql</files>
  <action>
Add an analytics_events table with minimal fields (event_name, journey, step, source, path, referrer, metadata, created_at). Enable RLS and add service_role-only insert/select policies. Create indexes on created_at and event_name to support basic reporting. Keep naming and SQL style consistent with existing tables.
  </action>
  <verify>rg "analytics_events" supabase/schema.sql</verify>
  <done>Schema includes analytics_events table, RLS enabled, and policies defined.</done>
</task>

<task type="auto">
  <name>Create analytics API route and client helper</name>
  <files>src/app/api/analytics/route.ts, src/lib/analytics.ts</files>
  <action>
Create a POST /api/analytics route that validates required fields, normalizes strings, and inserts into analytics_events using a Supabase service-role client. If required env vars are missing, return a 202 with a warning and avoid throwing. Add a client helper (trackEvent) that posts JSON to /api/analytics and silently handles network errors. Keep payloads small and avoid collecting PII beyond optional source/path/referrer metadata.
  </action>
  <verify>npm run lint</verify>
  <done>trackEvent can send events and the API route safely persists them when configured.</done>
</task>

</tasks>

<verification>
- `rg "analytics_events" supabase/schema.sql` confirms schema wiring
- `npm run lint` passes after adding analytics route/helper
</verification>

<success_criteria>
- Analytics events can be accepted and stored without runtime errors
- Client code has a stable helper to emit events
</success_criteria>

<output>
After completion, create `.planning/phases/08-8-functionality-expansion-we-are-going-to-make-sure-it-works-exactly-like-we-want-it-to-we-want-it-completely-functional/08-01-SUMMARY.md`
</output>
