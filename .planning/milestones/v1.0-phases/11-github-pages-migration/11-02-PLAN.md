---
phase: 11-github-pages-migration
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified: [src/app/api/insights/generate/route.ts, src/app/api/health/route.ts, src/app/api/export/route.ts, src/app/api/agency-stats/route.ts, src/lib/export.ts, src/lib/self-assessment.ts]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "API routes are converted to client-side functions"
    - "Data export works without server-side API"
    - "Agency stats are calculated client-side"
    - "Self-assessment scoring works client-side"
  artifacts:
    - path: "src/lib/client-api.ts"
      provides: "Client-side replacement for API routes"
    - path: "src/lib/static-data.ts"
      provides: "Static data loading for agency stats"
    - path: "src/lib/client-export.ts"
      provides: "Client-side CSV/Excel export"
  key_links:
    - from: "ExportButton component"
      to: "client-export.ts"
      via: "direct import"
      pattern: "import.*client-export"
---

<objective>
Convert server-side API routes and dynamic functionality to client-side alternatives compatible with GitHub Pages static hosting.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/11-github-pages-migration/11-01-PLAN.md
@src/app/api/export/route.ts
@src/app/api/agency-stats/route.ts
@src/app/api/insights/generate/route.ts
@src/lib/export.ts
@src/lib/self-assessment.ts
</context>

<tasks>

<task type="auto">
  <name>Create client-side API replacement</name>
  <files>src/lib/client-api.ts</files>
  <action>
Create a client-side library to replace server API functionality:

```typescript
// src/lib/client-api.ts
import { calculateAgencyStats } from './agency-stats';
import { generateCSV, generateExcel } from './export';
import { calculateSelfAssessmentScore } from './self-assessment';

/**
 * Client-side replacement for /api/agency-stats
 */
export async function getAgencyStatsClient(projects: any[]) {
  return calculateAgencyStats(projects);
}

/**
 * Client-side replacement for /api/export
 */
export async function exportDataClient(
  projects: any[],
  format: 'csv' | 'excel',
  filename: string
) {
  if (format === 'csv') {
    const csv = generateCSV(projects);
    downloadFile(csv, `${filename}.csv`, 'text/csv');
  } else {
    const excel = await generateExcel(projects);
    downloadFile(excel, `${filename}.xlsx`, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
  }
}

/**
 * Client-side replacement for /api/insights/generate
 */
export async function generateInsightsClient(projects: any[]) {
  // Simple insights generation based on project data
  const highScoreProjects = projects.filter(p => p.score >= 80);
  const lowScoreProjects = projects.filter(p => p.score < 60);
  
  return {
    totalProjects: projects.length,
    highScoreCount: highScoreProjects.length,
    lowScoreCount: lowScoreProjects.length,
    averageScore: projects.reduce((sum, p) => sum + p.score, 0) / projects.length,
    insights: [
      `Found ${highScoreProjects.length} projects with excellent compliance scores (â‰¥80)`,
      `Identified ${lowScoreProjects.length} projects needing attention (<60)`,
      `Overall average score: ${Math.round(projects.reduce((sum, p) => sum + p.score, 0) / projects.length)}`
    ]
  };
}

/**
 * Helper function to download files
 */
function downloadFile(content: string | Blob, filename: string, mimeType: string) {
  const blob = content instanceof Blob ? content : new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}
```
  </action>
  <verify>
TypeScript compilation succeeds
  </verify>
  <done>Client-side API library created</done>
</task>

<task type="auto">
  <name>Update export functionality for client-side</name>
  <files>src/lib/client-export.ts, src/components/ExportButton.tsx</files>
  <action>
Create client-side export functionality and update the ExportButton component:

1. First, create src/lib/client-export.ts:
```typescript
// src/lib/client-export.ts
import { generateCSV, generateExcel } from './export';

export async function downloadCSV(projects: any[], filename: string) {
  const csv = generateCSV(projects);
  downloadFile(csv, `${filename}.csv`, 'text/csv');
}

export async function downloadExcel(projects: any[], filename: string) {
  const excel = await generateExcel(projects);
  downloadFile(excel, `${filename}.xlsx`, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
}

function downloadFile(content: string | Blob, filename: string, mimeType: string) {
  const blob = content instanceof Blob ? content : new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}
```

2. Update src/components/ExportButton.tsx to use client-side export:
```typescript
// Update the handleExport function
import { downloadCSV, downloadExcel } from '@/lib/client-export';

const handleExport = async (format: 'csv' | 'excel') => {
  const filename = `projects-${new Date().toISOString().split('T')[0]}`;
  
  if (format === 'csv') {
    await downloadCSV(projects, filename);
  } else {
    await downloadExcel(projects, filename);
  }
  
  setIsOpen(false);
};
```
  </action>
  <verify>
ExportButton component compiles and export functions work
  </verify>
  <done>Client-side export functionality implemented</done>
</task>

<task type="auto">
  <name>Update agency stats to work client-side</name>
  <files>src/components/DashboardMetrics.tsx, src/lib/static-data.ts</files>
  <action>
Update the DashboardMetrics component to calculate agency stats client-side:

1. Create src/lib/static-data.ts for pre-computed data:
```typescript
// src/lib/static-data.ts
import { calculateAgencyStats } from './agency-stats';

/**
 * Pre-compute agency stats from projects data
 */
export function getStaticAgencyStats(projects: any[]) {
  return calculateAgencyStats(projects);
}

/**
 * Simulate API delay for realistic loading experience
 */
export async function loadAgencyStatsWithDelay(projects: any[], delay = 500) {
  await new Promise(resolve => setTimeout(resolve, delay));
  return getStaticAgencyStats(projects);
}
```

2. Update src/components/DashboardMetrics.tsx to use client-side calculation:
```typescript
// Update the useEffect that fetches agency stats
import { loadAgencyStatsWithDelay } from '@/lib/static-data';

useEffect(() => {
  const loadAgencyStats = async () => {
    try {
      setAgencyStatsLoading(true);
      const stats = await loadAgencyStatsWithDelay(projects);
      setAgencyStats(stats);
    } catch (error) {
      console.error('Failed to load agency stats:', error);
    } finally {
      setAgencyStatsLoading(false);
    }
  };

  if (projects.length > 0) {
    loadAgencyStats();
  }
}, [projects]);
```
  </action>
  <verify>
DashboardMetrics component loads agency stats client-side
  </verify>
  <done>Agency stats converted to client-side calculation</done>
</task>

</tasks>

<verification>
- Test all client-side functionality works correctly
- Verify export buttons produce downloadable files
- Check agency charts render with client-side data
- Ensure no API route calls remain in the codebase
</verification>

<success_criteria>
- [ ] Export functionality works without server API calls
- [ ] Agency stats calculate client-side
- [ ] Self-assessment scoring works client-side  
- [ ] No remaining references to /api/ routes in client code
- [ ] All dynamic functionality converted to static-compatible alternatives
</success_criteria>

<output>
After completion, create `.planning/phases/11-github-pages-migration/11-02-SUMMARY.md`
</output>