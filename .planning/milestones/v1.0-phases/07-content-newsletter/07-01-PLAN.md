---
phase: "07-content-newsletter"
plan: "01"
type: "execute"
wave: 1
depends_on: []
files_modified:
  - "supabase/schema.sql"
  - "src/lib/auth.ts"
  - "src/app/api/newsletter/subscribe/route.ts"
  - "src/components/NewsletterSignupForm.tsx"
  - "src/app/newsletter/page.tsx"
  - "src/app/page.tsx"
  - "src/components/SiteFooter.tsx"
  - "src/app/layout.tsx"
autonomous: false
user_setup:
  - service: supabase
    why: "Store newsletter subscribers and interests"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Settings -> API"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Settings -> API (admin writes)"
    dashboard_config:
      - task: "Apply newsletter_subscribers table SQL"
        location: "Supabase Dashboard -> SQL Editor"
must_haves:
  truths:
    - "Newsletter signup form exists with email, organization, role, and interests"
    - "Dedicated newsletter page is accessible"
    - "Newsletter signups are stored in Supabase"
    - "Inline success state confirms signup"
    - "Site footer includes newsletter link"
  artifacts:
    - path: "src/components/NewsletterSignupForm.tsx"
      provides: "Newsletter signup form with interests"
      exports: "NewsletterSignupForm component"
    - path: "src/app/api/newsletter/subscribe/route.ts"
      provides: "Newsletter signup API endpoint"
      exports: "POST handler for newsletter subscriptions"
    - path: "src/app/newsletter/page.tsx"
      provides: "Dedicated newsletter landing page"
      exports: "Newsletter page"
    - path: "supabase/schema.sql"
      provides: "Newsletter subscribers table schema"
      exports: "CREATE TABLE newsletter_subscribers"
  key_links:
    - from: "src/components/NewsletterSignupForm.tsx"
      to: "/api/newsletter/subscribe"
      via: "POST fetch"
      pattern: "fetch.*newsletter/subscribe"
    - from: "src/app/layout.tsx"
      to: "src/components/SiteFooter.tsx"
      via: "render footer"
      pattern: "SiteFooter"
---

<objective>
Create a newsletter signup experience with dedicated page, stored subscriptions, and site-wide entry points.

Purpose: Build a reliable pipeline for collecting newsletter subscribers interested in data-driven findings.
Output: Newsletter signup form, API endpoint, Supabase table, and navigation entry points
</objective>

<execution_context>
@./.planning/phases/06-polish/06-01-SUMMARY.md
@./.planning/ROADMAP.md
</execution_context>

<context>
@./.planning/phases/07-content-newsletter/07-CONTEXT.md
@./src/components/EmailGateForm.tsx
@./src/lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add newsletter_subscribers table to Supabase schema</name>
  <files>supabase/schema.sql</files>
  <action>
    Update supabase/schema.sql to add a newsletter_subscribers table:
    - Columns: id (uuid), email (unique), organization, role, interests (text[]), status (pending|confirmed), source, created_at, updated_at, confirmed_at
    - Indexes on email and created_at
    - Enable RLS with policies allowing insert for anon and select for authenticated
    - Add update policy for authenticated users (email match)
  </action>
  <verify>grep -q "newsletter_subscribers" supabase/schema.sql</verify>
  <done>Newsletter subscribers table and policies defined</done>
</task>

<task type="auto">
  <name>Task 2: Extend auth helper for configurable magic link redirect</name>
  <files>src/lib/auth.ts</files>
  <action>
    Update sendMagicLink helpers to accept an optional redirect path:
    - Add optional parameter redirectPath
    - Default to /gated-reports if undefined
    - Ensure newsletter signup can request redirect to /newsletter
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Magic link helper supports custom redirect path</done>
</task>

<task type="auto">
  <name>Task 3: Create newsletter subscribe API route</name>
  <files>src/app/api/newsletter/subscribe/route.ts</files>
  <action>
    Create POST endpoint for newsletter signup:
    - Accept { email, organization?, role?, interests? } in JSON body
    - Validate email format and required fields
    - Upsert into newsletter_subscribers table (lowercase email)
    - Send magic link with redirect to /newsletter (optional confirmation)
    - Return success message without leaking subscriber existence
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Newsletter subscribe endpoint accepts signups and stores records</done>
</task>

<task type="auto">
  <name>Task 4: Build NewsletterSignupForm component</name>
  <files>src/components/NewsletterSignupForm.tsx</files>
  <action>
    Create a client-side NewsletterSignupForm component:
    - Fields: email (required), organization, role, interests (multi-select or checkboxes)
    - Role options aligned with existing EmailGateForm
    - Inline success state that keeps user on page
    - Error messaging and loading state
    - Tailwind styles consistent with existing forms
  </action>
  <verify>npx tsc --noEmit && ls src/components/NewsletterSignupForm.tsx</verify>
  <done>NewsletterSignupForm renders with validation and success state</done>
</task>

<task type="auto">
  <name>Task 5: Create newsletter page</name>
  <files>src/app/newsletter/page.tsx</files>
  <action>
    Create newsletter landing page:
    - Page header explaining data-driven newsletter
    - Include NewsletterSignupForm component
    - Add short list of example topics (scores, spending concentration, trends)
    - Use existing layout and typography patterns
  </action>
  <verify>npm run build</verify>
  <done>/newsletter page renders with signup form</done>
</task>

<task type="auto">
  <name>Task 6: Add newsletter link in navigation and footer</name>
  <files>src/components/SiteFooter.tsx, src/app/layout.tsx, src/app/page.tsx</files>
  <action>
    Add newsletter entry points:
    - Create SiteFooter component with newsletter link and short copy
    - Render SiteFooter in RootLayout to appear site-wide
    - Add "Newsletter" link in homepage header nav
  </action>
  <verify>npm run build</verify>
  <done>Newsletter link visible in header and footer</done>
</task>

</tasks>

<verification>
- [ ] /newsletter page loads and form submits successfully
- [ ] Newsletter signup writes record to newsletter_subscribers table
- [ ] Success state appears inline after submit
- [ ] Header and footer include newsletter link
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
</verification>

<success_criteria>
Users can:
- Find the newsletter page from navigation and footer
- Submit email with organization, role, and interests
- See immediate confirmation without leaving the page
- Be stored as a newsletter subscriber in Supabase
</success_criteria>

<output>
After completion, create `.planning/phases/07-content-newsletter/07-01-SUMMARY.md`
</output>
