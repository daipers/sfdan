---
phase: "07-content-newsletter"
plan: "03"
type: "execute"
wave: 1
depends_on: []
files_modified:
  - "supabase/schema.sql"
  - "src/lib/content.ts"
  - "src/lib/admin.ts"
  - "src/app/api/content/route.ts"
  - "src/app/api/content/[slug]/route.ts"
  - "src/app/api/insights/approve/route.ts"
  - "src/app/content/page.tsx"
  - "src/app/content/[slug]/page.tsx"
  - "src/app/admin/insights/page.tsx"
  - "src/components/ContentCard.tsx"
  - "src/components/ContentFilters.tsx"
  - "src/components/NewsletterPrompt.tsx"
  - "src/components/NewsletterSignupForm.tsx"
  - "src/app/page.tsx"
  - "src/components/SiteFooter.tsx"
autonomous: false
user_setup:
  - service: supabase
    why: "Store content posts and manage publish status"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Settings -> API (admin writes)"
    dashboard_config:
      - task: "Apply content_posts table SQL"
        location: "Supabase Dashboard -> SQL Editor"
  - service: env
    why: "Protect admin review routes"
    env_vars:
      - name: ADMIN_EMAILS
        source: "Comma-separated allowlist for admin access"
must_haves:
  truths:
    - "Content library page lists published findings with filters"
    - "Content detail pages show executive summary, findings, methodology, and data"
    - "Newsletter signup is required for gated content"
    - "Insights can be reviewed and approved before publishing"
    - "Inline newsletter prompts appear on content pages"
  artifacts:
    - path: "src/app/content/page.tsx"
      provides: "Content library index"
      exports: "Content page"
    - path: "src/app/content/[slug]/page.tsx"
      provides: "Content detail page"
      exports: "Content detail"
    - path: "src/app/admin/insights/page.tsx"
      provides: "Admin review interface"
      exports: "Admin insights review page"
    - path: "supabase/schema.sql"
      provides: "Content posts table schema"
      exports: "CREATE TABLE content_posts"
  key_links:
    - from: "src/app/content/[slug]/page.tsx"
      to: "src/components/NewsletterSignupForm.tsx"
      via: "render gated prompt"
      pattern: "NewsletterSignupForm"
    - from: "src/app/admin/insights/page.tsx"
      to: "src/app/api/insights/approve/route.ts"
      via: "POST approve"
      pattern: "insights/approve"
---

<objective>
Create a content publishing system with searchable library, gated access, and editorial approval workflow.

Purpose: Turn automated insights into publishable, data-driven content that drives newsletter subscriptions.
Output: Content tables, library and detail pages, admin review UI, and gated access flow
</objective>

<execution_context>
@./.planning/phases/07-content-newsletter/07-02-PLAN.md
@./.planning/ROADMAP.md
</execution_context>

<context>
@./.planning/phases/07-content-newsletter/07-CONTEXT.md
@./src/components/EmailGateForm.tsx
@./src/components/NewsletterSignupForm.tsx
@./src/lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add content_posts table and relationships</name>
  <files>supabase/schema.sql</files>
  <action>
    Extend supabase/schema.sql with content_posts table:
    - Columns: id (uuid), slug (unique), title, summary, sections (jsonb),
      insight_ids (uuid[]), status (draft|review|published), is_gated (bool),
      published_at, approved_at, approved_by, created_at, updated_at
    - Add content_sources table or data_sources jsonb in content_posts
    - Index on status, published_at, slug
    - Enable RLS with select for published, admin for drafts
  </action>
  <verify>grep -q "CREATE TABLE.*content_posts" supabase/schema.sql</verify>
  <done>Content posts schema defined with publish metadata</done>
</task>

<task type="auto">
  <name>Task 2: Add content data access helpers</name>
  <files>src/lib/content.ts, src/lib/admin.ts</files>
  <action>
    Create content data access helpers:
    - getPublishedContent(filters) with search, type, and date filters
    - getContentBySlug(slug) for detail pages
    - createContentDraftFromInsight(insight) for admin flow
    - publishContent(id) to set status and published_at
    - add admin allowlist check in src/lib/admin.ts using ADMIN_EMAILS
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Content and admin helpers available for pages and API routes</done>
</task>

<task type="auto">
  <name>Task 3: Create content API routes</name>
  <files>src/app/api/content/route.ts, src/app/api/content/[slug]/route.ts</files>
  <action>
    Add content API endpoints:
    - GET /api/content returns published content with filters
    - POST /api/content (admin) creates draft content from insight
    - GET /api/content/[slug] returns full content detail
    - Use admin allowlist for write operations
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Content API endpoints serve library and detail data</done>
</task>

<task type="auto">
  <name>Task 4: Build content library page with filters</name>
  <files>src/app/content/page.tsx, src/components/ContentCard.tsx, src/components/ContentFilters.tsx</files>
  <action>
    Create content library page at /content:
    - Fetch published content list from API or server helper
    - Add search + filters (type, agency/state tags, date range)
    - Default sort by newest published
    - Render ContentCard list with summary, key metric, and tags
  </action>
  <verify>npm run build</verify>
  <done>/content displays searchable list of published findings</done>
</task>

<task type="auto">
  <name>Task 5: Build content detail pages with sections</name>
  <files>src/app/content/[slug]/page.tsx, src/components/NewsletterPrompt.tsx</files>
  <action>
    Create content detail page:
    - Render sections: executive summary, key findings, methodology, data table/chart
    - Include citations and Data Sources section
    - If is_gated, check subscriber status and show NewsletterSignupForm before content
    - Add inline NewsletterPrompt below key findings
  </action>
  <verify>npm run build</verify>
  <done>Content detail pages render structured sections with gated access</done>
</task>

<task type="auto">
  <name>Task 6: Add editorial approval workflow</name>
  <files>src/app/admin/insights/page.tsx, src/app/api/insights/approve/route.ts</files>
  <action>
    Create admin review page:
    - List insights with status pending_review
    - Allow approve/publish actions (single admin approval)
    - Approve sets status to approved and publishes immediately
    - Respect auto_publish_eligible flag for low-risk insights
    - Guard access with ADMIN_EMAILS allowlist
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Admin review page can approve and publish insights</done>
</task>

<task type="auto">
  <name>Task 7: Add content navigation entries</name>
  <files>src/app/page.tsx, src/components/SiteFooter.tsx</files>
  <action>
    Add content discovery links:
    - Add "Findings" link to homepage header nav
    - Add content library and newsletter links in footer
  </action>
  <verify>npm run build</verify>
  <done>Users can discover content library and newsletter</done>
</task>

</tasks>

<verification>
- [ ] /content lists published findings with filters and search
- [ ] Content detail pages render required sections and citations
- [ ] Gated content requires newsletter signup before full access
- [ ] Admin review page approves and publishes insights
- [ ] Inline newsletter prompts appear on content pages
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
</verification>

<success_criteria>
Users can:
- Browse a searchable library of data-driven findings
- Read structured content pages with methodology and data sources
- Subscribe to access gated content
Admins can:
- Review automated insights and publish approved content immediately
</success_criteria>

<output>
After completion, create `.planning/phases/07-content-newsletter/07-03-SUMMARY.md`
</output>
