---
phase: "07-content-newsletter"
plan: "02"
type: "execute"
wave: 1
depends_on: []
files_modified:
  - "supabase/schema.sql"
  - "src/lib/insights.ts"
  - "src/app/api/insights/generate/route.ts"
  - "src/app/api/insights/route.ts"
  - "vercel.json"
autonomous: false
user_setup:
  - service: supabase
    why: "Store generated insights and their review status"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Settings -> API (admin writes)"
    dashboard_config:
      - task: "Apply insights table SQL"
        location: "Supabase Dashboard -> SQL Editor"
  - service: vercel
    why: "Schedule automated insight generation"
    env_vars:
      - name: INSIGHTS_CRON_SECRET
        source: "Generate and store in Vercel project env vars"
must_haves:
  truths:
    - "Automated insights can be generated from project data"
    - "Insights capture threshold and cadence triggers"
    - "Insights are stored with review status"
    - "Low-risk insights are marked as auto-publish eligible"
    - "Insights list endpoint returns generated insights"
  artifacts:
    - path: "src/lib/insights.ts"
      provides: "Insight generation logic"
      exports: "generateInsights function"
    - path: "src/app/api/insights/generate/route.ts"
      provides: "Insight generation API"
      exports: "POST handler for cron"
    - path: "supabase/schema.sql"
      provides: "Insights table schema"
      exports: "CREATE TABLE insights"
  key_links:
    - from: "src/app/api/insights/generate/route.ts"
      to: "src/lib/insights.ts"
      via: "import and call"
      pattern: "generateInsights"
    - from: "vercel.json"
      to: "/api/insights/generate"
      via: "cron path"
      pattern: "insights/generate"
---

<objective>
Implement automated insight generation from project data with cadence and threshold triggers.

Purpose: Produce repeatable, data-driven findings that feed into published content with review controls.
Output: Insight generation library, API endpoints, database storage, and scheduled cron
</objective>

<execution_context>
@./.planning/phases/07-content-newsletter/07-01-PLAN.md
@./.planning/ROADMAP.md
</execution_context>

<context>
@./.planning/phases/07-content-newsletter/07-CONTEXT.md
@./src/lib/usaspending.ts
@./src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add insights table to Supabase schema</name>
  <files>supabase/schema.sql</files>
  <action>
    Extend supabase/schema.sql with insights table:
    - Columns: id (uuid), type, title, summary, metrics (jsonb), evidence (jsonb),
      trigger_type (cadence|threshold), risk_level (low|medium|high),
      status (pending_review|approved|published), auto_publish_eligible (bool),
      period_start, period_end, generated_at, approved_at, published_at
    - Add unique fingerprint column for de-duplication
    - Index on status, type, generated_at
    - Enable RLS with select for authenticated and insert for service role
  </action>
  <verify>grep -q "CREATE TABLE.*insights" supabase/schema.sql</verify>
  <done>Insights table schema and indexes defined</done>
</task>

<task type="auto">
  <name>Task 2: Create insight generation library</name>
  <files>src/lib/insights.ts</files>
  <action>
    Create src/lib/insights.ts with insight generation utilities:
    - Define InsightDraft type with title, summary, metrics, evidence, trigger_type, risk_level, auto_publish_eligible
    - Implement generators:
      1) Score outliers (top 5% and bottom 5% by score)
      2) Spending concentration (top agencies/states as % of total)
      3) Month-over-month change (largest shifts in total spending)
    - Use both cadence and threshold triggers:
      - Threshold: publish if change exceeds X% (set X=25%)
      - Cadence: weekly or monthly baseline when no threshold triggered
    - Return insights with fingerprint for de-duplication
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Insight generation functions return structured drafts</done>
</task>

<task type="auto">
  <name>Task 3: Create insights generation API route</name>
  <files>src/app/api/insights/generate/route.ts</files>
  <action>
    Create POST /api/insights/generate:
    - Require INSIGHTS_CRON_SECRET header
    - Fetch awards data (page through USASpending if needed)
    - Call generateInsights and upsert new insights by fingerprint
    - Set status to pending_review, auto_publish_eligible for low-risk types
    - Return counts for created vs skipped
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Insights generation endpoint stores drafts in Supabase</done>
</task>

<task type="auto">
  <name>Task 4: Add insights list API route</name>
  <files>src/app/api/insights/route.ts</files>
  <action>
    Create GET /api/insights:
    - Query Supabase insights table
    - Support query params: status, type, limit
    - Default to published or approved insights for public access
    - Return JSON list with metadata for content pipeline
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Insights list endpoint returns generated insights</done>
</task>

<task type="auto">
  <name>Task 5: Configure scheduled insights generation</name>
  <files>vercel.json</files>
  <action>
    Add Vercel cron configuration:
    - Schedule weekly run (e.g., Mondays at 08:00 UTC)
    - Call /api/insights/generate with INSIGHTS_CRON_SECRET
    - Document cadence choice in comments or README if needed
  </action>
  <verify>ls vercel.json</verify>
  <done>Cron schedule configured for insight generation</done>
</task>

</tasks>

<verification>
- [ ] POST /api/insights/generate creates or updates insights
- [ ] Generated insights include trigger_type, risk_level, and auto_publish_eligible
- [ ] GET /api/insights returns list with filters
- [ ] Cron schedule exists for weekly generation
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
</verification>

<success_criteria>
Automated insight generation produces:
- Outlier scores, spending concentration, and month-over-month shifts
- Threshold-triggered insights with clear trigger metadata
- Cadence-based insights when thresholds are not met
- Stored insights ready for review and publishing
</success_criteria>

<output>
After completion, create `.planning/phases/07-content-newsletter/07-02-SUMMARY.md`
</output>
