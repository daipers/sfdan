---
phase: 09-stabilization-and-deployment-hardening
plan: 02
type: execute
wave: 2
depends_on: [09-01]
files_modified:
  - package.json
  - middleware.ts
  - src/lib/rate-limit.ts
  - src/lib/config.ts
autonomous: true
requirements: [STAB-03, STAB-04]
user_setup:
  - service: upstash
    why: "Per-IP rate limiting for API routes"
    env_vars:
      - name: UPSTASH_REDIS_REST_URL
        source: "Upstash Redis database -> REST URL"
      - name: UPSTASH_REDIS_REST_TOKEN
        source: "Upstash Redis database -> REST Token"

must_haves:
  truths:
    - "API requests are rate limited per IP with clear 429 responses"
    - "Health checks remain reachable without rate limiting"
  artifacts:
    - path: "middleware.ts"
      provides: "Edge rate limiting for /api routes"
      contains: "Ratelimit"
    - path: "src/lib/rate-limit.ts"
      provides: "Shared Upstash rate limiter configuration"
      exports: ["rateLimit", "getClientIp"]
    - path: "src/lib/config.ts"
      provides: "Upstash env validation"
      contains: "UPSTASH_REDIS_REST_"
  key_links:
    - from: "middleware.ts"
      to: "src/lib/rate-limit.ts"
      via: "rateLimit"
      pattern: "rateLimit\.limit"
    - from: "src/lib/rate-limit.ts"
      to: "UPSTASH_REDIS_REST_URL"
      via: "env"
      pattern: "UPSTASH_REDIS_REST_"
---

<objective>
Enforce per-IP rate limits at the edge to protect APIs and avoid abuse.

Purpose: Provide reliability safeguards without adding per-route boilerplate.
Output: Edge middleware + shared rate limiter with required env validation.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@package.json
@src/app/api/analytics/route.ts
@src/app/api/newsletter/subscribe/route.ts
</context>

<tasks>

<task type="auto">
  <name>Add Upstash-backed edge rate limiting middleware</name>
  <files>package.json, middleware.ts, src/lib/rate-limit.ts</files>
  <action>
Install `@upstash/ratelimit` and `@upstash/redis`. Create `src/lib/rate-limit.ts` that initializes a sliding-window limiter (e.g., 120 req/min) using Upstash REST credentials and exposes `getClientIp()` that reads `request.ip` and `x-forwarded-for` safely. Add `middleware.ts` to apply rate limiting to all `/api` routes except `/api/health`, returning `429` JSON with `Retry-After` and `X-RateLimit-*` headers when exceeded. Keep middleware compatible with Edge runtime.
  </action>
  <verify>npm run lint</verify>
  <done>API requests over the limit receive a 429 response with rate limit headers.</done>
</task>

<task type="auto">
  <name>Extend config validation for Upstash credentials</name>
  <files>src/lib/config.ts</files>
  <action>
Add Upstash REST URL/token to the required server env list and surface them in the aggregated validation error. Keep naming and error formatting consistent with the existing `assertServerConfig()` output.
  </action>
  <verify>npm run lint</verify>
  <done>Missing Upstash credentials trigger the same fail-fast validation behavior.</done>
</task>

</tasks>

<verification>
- `npm run lint` succeeds after middleware + rate limiter additions
- `/api/*` returns 429 when the rate limit is exceeded, while `/api/health` remains reachable
</verification>

<success_criteria>
- Per-IP limits protect API routes without code changes to each handler
- Health checks bypass rate limiting for uptime monitoring
</success_criteria>

<output>
After completion, create `.planning/phases/09-stabilization-and-deployment-hardening/09-02-SUMMARY.md`
</output>
