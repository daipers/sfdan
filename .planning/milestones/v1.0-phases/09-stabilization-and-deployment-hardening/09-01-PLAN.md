---
phase: 09-stabilization-and-deployment-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - next.config.ts
  - sentry.client.config.ts
  - sentry.server.config.ts
  - sentry.edge.config.ts
  - src/instrumentation.ts
  - src/app/api/health/route.ts
  - src/lib/health.ts
  - src/lib/config.ts
autonomous: true
requirements: [STAB-02, STAB-03, STAB-04]
user_setup:
  - service: sentry
    why: "Error and failed request alerting with warning/critical tiers"
    env_vars:
      - name: SENTRY_DSN
        source: "Sentry Project Settings -> Client Keys (DSN)"
      - name: SENTRY_ENVIRONMENT
        source: "Set to staging/production per environment"
    dashboard_config:
      - task: "Create warning + critical alert rules for error rate and failed request metrics"
        location: "Sentry -> Alerts -> Create Alert Rule"
      - task: "Add Slack and email notification actions"
        location: "Sentry -> Alerts -> Integrations/Actions"
      - task: "Configure uptime monitor for /api/health"
        location: "Sentry -> Uptime Monitoring"

must_haves:
  truths:
    - "Errors and failed requests are captured in Sentry with environment tagging"
    - "Health checks report dependency status with 200/503 responses"
    - "Server startup fails fast when required configuration is missing"
  artifacts:
    - path: "sentry.client.config.ts"
      provides: "Client-side Sentry initialization"
      contains: "Sentry.init"
    - path: "sentry.server.config.ts"
      provides: "Server-side Sentry initialization"
      contains: "Sentry.init"
    - path: "sentry.edge.config.ts"
      provides: "Edge runtime Sentry initialization"
      contains: "Sentry.init"
    - path: "src/instrumentation.ts"
      provides: "Startup registration and config validation"
      exports: ["register"]
    - path: "src/app/api/health/route.ts"
      provides: "Health endpoint with dependency checks"
      exports: ["GET"]
    - path: "src/lib/health.ts"
      provides: "Health check helpers for DB and external API"
      exports: ["checkSupabase", "checkUsaspending"]
    - path: "src/lib/config.ts"
      provides: "Strict runtime configuration validation"
      exports: ["assertServerConfig"]
  key_links:
    - from: "src/instrumentation.ts"
      to: "src/lib/config.ts"
      via: "assertServerConfig"
      pattern: "assertServerConfig\(\)"
    - from: "src/app/api/health/route.ts"
      to: "src/lib/health.ts"
      via: "dependency checks"
      pattern: "checkSupabase|checkUsaspending"
    - from: "sentry.server.config.ts"
      to: "@sentry/nextjs"
      via: "Sentry.init"
      pattern: "Sentry\.init"
---

<objective>
Add production-grade observability, health checks, and strict config validation for stable deployments.

Purpose: Ensure failures surface immediately and uptime monitoring can verify dependencies.
Output: Sentry SDK setup, health endpoint + helpers, and startup config validation.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@package.json
@next.config.ts
@src/lib/supabase-server.ts
@src/lib/usaspending.ts
</context>

<tasks>

<task type="auto">
  <name>Add Sentry SDK initialization for client/server/edge</name>
  <files>package.json, next.config.ts, sentry.client.config.ts, sentry.server.config.ts, sentry.edge.config.ts, src/instrumentation.ts</files>
  <action>
Install `@sentry/nextjs`, then add Sentry config files for client/server/edge that call `Sentry.init` with DSN and environment from env vars. Update `next.config.ts` to wrap the config with `withSentryConfig` only when `SENTRY_AUTH_TOKEN` is present (avoid build failures when missing). Add `src/instrumentation.ts` with a `register()` function that calls `assertServerConfig()` before any runtime bootstrapping so misconfiguration fails fast.
  </action>
  <verify>npm run lint</verify>
  <done>Sentry initializes without runtime errors and startup validation runs via instrumentation.</done>
</task>

<task type="auto">
  <name>Create health endpoint with dependency checks</name>
  <files>src/app/api/health/route.ts, src/lib/health.ts</files>
  <action>
Add a health helper module that runs a lightweight Supabase check (service-role client, simple `select` or `rpc` with timeout) and a minimal USASpending API probe using `fetch` with an `AbortController` timeout. Return structured results with `ok`, `latencyMs`, and `error` fields. Implement `GET /api/health` that returns `200` when all checks are ok and `503` when any dependency fails; include `status`, `checks`, and `timestamp` in JSON. Keep the route `runtime = "nodejs"`.
  </action>
  <verify>npm run lint</verify>
  <done>`/api/health` reports dependency status and fails with 503 on failed checks.</done>
</task>

<task type="auto">
  <name>Implement strict runtime config validation</name>
  <files>src/lib/config.ts, src/instrumentation.ts</files>
  <action>
Create `assertServerConfig()` that validates required env vars used by server-only paths (Supabase URL/anon key, `SUPABASE_SERVICE_ROLE_KEY`, `NEXT_PUBLIC_SITE_URL`, and Sentry DSN) and throws a clear, aggregated error when any are missing. Ensure `register()` in `src/instrumentation.ts` calls the assertion at startup so deployments fail fast instead of degrading silently.
  </action>
  <verify>npm run lint</verify>
  <done>Missing required env vars cause immediate startup failure with actionable error text.</done>
</task>

</tasks>

<verification>
- `npm run lint` succeeds after Sentry + health/config additions
- `/api/health` returns structured JSON with status + checks
</verification>

<success_criteria>
- Sentry captures errors with environment tags and alert rules can be configured
- Health endpoint reports DB/API status and fails fast when dependencies are down
- Missing required env vars stop startup instead of silently degrading
</success_criteria>

<output>
After completion, create `.planning/phases/09-stabilization-and-deployment-hardening/09-01-SUMMARY.md`
</output>
