---
phase: 09-stabilization-and-deployment-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - netlify.toml
  - docs/operations/release-workflow.md
  - docs/operations/incident-log.md
  - docs/operations/postmortem-template.md
autonomous: true
requirements: [STAB-01, STAB-03, STAB-04]
user_setup:
  - service: netlify
    why: "Staging/production releases with manual approval and rollback"
    dashboard_config:
      - task: "Create a staging environment with its own env vars"
        location: "Netlify -> Site settings -> Build & deploy -> Environment"
      - task: "Require manual promotion for production deployments"
        location: "Netlify -> Deploys -> Production deploys"

must_haves:
  truths:
    - "Release workflow documents blue/green promotion with a health-gated auto-rollback"
    - "Deploys fail when tests fail prior to build"
    - "Incident logging and postmortem templates are available for responders"
  artifacts:
    - path: "netlify.toml"
      provides: "Build command with test gate"
      contains: "test:run"
    - path: "docs/operations/release-workflow.md"
      provides: "Blue/green workflow with approval, health gate, and rollback"
      contains: "blue/green"
    - path: "docs/operations/incident-log.md"
      provides: "Incident log template"
      contains: "Incident Log"
    - path: "docs/operations/postmortem-template.md"
      provides: "Postmortem notes template"
      contains: "Postmortem"
  key_links:
    - from: "docs/operations/release-workflow.md"
      to: "/api/health"
      via: "health check verification"
      pattern: "api/health"
    - from: "docs/operations/release-workflow.md"
      to: "Netlify rollback"
      via: "auto-rollback step"
      pattern: "rollback"
    - from: "netlify.toml"
      to: "npm run test:run"
      via: "build command"
      pattern: "test:run"
---

<objective>
Define a hardened release workflow and enforce build gates before production deploys.

Purpose: Reduce deployment risk with staging validation, manual approval, and clear incident response artifacts.
Output: Release workflow docs, incident templates, and Netlify build protection updates.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@netlify.toml
</context>

<tasks>

<task type="auto">
  <name>Document blue/green release workflow with health-gated auto-rollback</name>
  <files>docs/operations/release-workflow.md</files>
  <action>
Create a concise release workflow document covering: blue/green strategy definitions (staging = green, production = blue), staging deploy trigger, validation steps (including `/api/health` and Sentry alert checks), manual approval gate before production promotion, and an auto-rollback mechanism tied to failed `/api/health` checks. Document the health gate as a deployment hook or post-promotion monitor that hits `/api/health` on a short interval and triggers a Netlify rollback (deploy history or CLI/API) automatically when checks fail. Include a checklist for required environment variables per environment and note that secrets live in the Netlify secret store (no `.env` files in repo).
  </action>
  <verify>rg "blue/green|staging|production|api/health|rollback" docs/operations/release-workflow.md</verify>
  <done>Release workflow provides blue/green promotion steps and auto-rollback on failed health checks.</done>
</task>

<task type="auto">
  <name>Add incident log and postmortem templates</name>
  <files>docs/operations/incident-log.md, docs/operations/postmortem-template.md</files>
  <action>
Add an incident log template with fields for timestamp, severity (warning/critical), impact, mitigation steps, and follow-up items. Add a postmortem template covering root cause, detection, timeline, remediation, and prevention tasks. Keep them short and fillable.
  </action>
  <verify>rg "Incident Log|Postmortem" docs/operations/incident-log.md docs/operations/postmortem-template.md</verify>
  <done>Incident response artifacts exist and can be used without additional formatting.</done>
</task>

<task type="auto">
  <name>Enforce build protections on Netlify</name>
  <files>netlify.toml</files>
  <action>
Update the Netlify build command to run unit tests before build (use `npm run test:run && npm run build`). Keep the Node version setting intact and avoid adding E2E tests to the build step.
  </action>
  <verify>rg "test:run" netlify.toml</verify>
  <done>Netlify build now fails if unit tests fail.</done>
</task>

</tasks>

<verification>
- `netlify.toml` includes a test gate in the build command
- Release workflow docs describe staging → approval → production promotion and rollback
- Incident log and postmortem templates are present
</verification>

<success_criteria>
- Release workflow is documented and enforces manual promotion to production
- Build protections prevent deployments when unit tests fail
- Incident response artifacts are ready for immediate use
</success_criteria>

<output>
After completion, create `.planning/phases/09-stabilization-and-deployment-hardening/09-03-SUMMARY.md`
</output>
