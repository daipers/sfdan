---
phase: "06-polish"
plan: "01"
type: "execute"
wave: 1
depends_on: []
files_modified:
  - "package.json"
  - "vitest.config.ts"
  - "src/lib/scoring.test.ts"
  - "src/lib/agency-stats.test.ts"
  - "src/lib/self-assessment.test.ts"
  - "src/lib/export.test.ts"
  - "src/app/not-found.tsx"
  - "src/app/layout.tsx"
  - "playwright.config.ts"
  - "tests/e2e.spec.ts"
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Key business logic functions have unit tests"
    - "Custom 404 page exists for invalid routes"
    - "SEO metadata includes Open Graph tags"
    - "Basic E2E smoke tests pass"
  artifacts:
    - path: "src/lib/scoring.test.ts"
      provides: "Unit tests for scoring functions"
    - path: "src/lib/agency-stats.test.ts"
      provides: "Unit tests for agency stats aggregation"
    - path: "src/lib/self-assessment.test.ts"
      provides: "Unit tests for self-assessment scoring"
    - path: "src/lib/export.test.ts"
      provides: "Unit tests for CSV/Excel export"
    - path: "src/app/not-found.tsx"
      provides: "Custom 404 error page"
    - path: "tests/e2e.spec.ts"
      provides: "Playwright E2E tests"
  key_links:
    - from: "package.json"
      to: "vitest.config.ts"
      via: "test script and config"
    - from: "package.json"
      to: "playwright.config.ts"
      via: "test:e2e script"
---

<objective>
Polish Phase: Add tests, error pages, and improve SEO metadata.

Purpose: Improve code quality, user experience for invalid routes, and search engine visibility.
Output: Test suite, custom 404, improved metadata
</objective>

<context>
@./src/lib/scoring.ts
@./src/lib/agency-stats.ts
@./src/lib/self-assessment.ts
@./src/lib/export.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Vitest for unit testing</name>
  <files>package.json, vitest.config.ts</files>
  <action>
    Install Vitest and set up test configuration:
    - Run: npm install -D vitest @vitejs/plugin-react jsdom
    - Create vitest.config.ts with React plugin and jsdom environment
    - Add test script to package.json: "test": "vitest", "test:run": "vitest run"
  </action>
  <verify>npm run test:run exits with 0 (no tests yet but config works)</verify>
  <done>Vitest configured and working</done>
</task>

<task type="auto">
  <name>Task 2: Write unit tests for scoring.ts</name>
  <files>src/lib/scoring.test.ts</files>
  <action>
    Create src/lib/scoring.test.ts:
    - Test calculateScore with full award data (should return high score)
    - Test calculateScore with missing critical dates (should return lower score)
    - Test calculateScore edge cases: no environmental review, no competition info
    - Test score breakdown returns correct structure
  </action>
  <verify>npm run test:run passes</verify>
  <done>Scoring function has 4+ test cases</done>
</task>

<task type="auto">
  <name>Task 3: Write unit tests for agency-stats.ts</name>
  <files>src/lib/agency-stats.test.ts</files>
  <action>
    Create src/lib/agency-stats.test.ts:
    - Test calculateAgencyStats with empty array (returns empty)
    - Test calculateAgencyStats with multiple agencies
    - Test sorting by total spending descending
    - Test score distribution calculation
    - Test "Unknown" agency handling for missing data
  </action>
  <verify>npm run test:run passes</verify>
  <done>Agency stats has 4+ test cases</done>
</task>

<task type="auto">
  <name>Task 4: Write unit tests for self-assessment.ts</name>
  <files>src/lib/self-assessment.test.ts</files>
  <action>
    Create src/lib/self-assessment.test.ts:
    - Test calculateSelfAssessmentScore with competitive award (high score)
    - Test calculateSelfAssessmentScore with sole source (lower score)
    - Test score breakdown generation
    - Test recommendations based on low scores
    - Test benchmark comparison function
  </action>
  <verify>npm run test:run passes</verify>
  <done>Self-assessment has 4+ test cases</done>
</task>

<task type="auto">
  <name>Task 5: Write unit tests for export.ts</name>
  <files>src/lib/export.test.ts</files>
  <action>
    Create src/lib/export.test.ts:
    - Test generateCSV with data (correct header + rows)
    - Test generateCSV with empty array (returns empty string)
    - Test CSV escaping for commas/quotes
    - Test transformForExport handles missing values
  </action>
  <verify>npm run test:run passes</verify>
  <done>Export has 3+ test cases</done>
</task>

<task type="auto">
  <name>Task 6: Create custom 404 page</name>
  <files>src/app/not-found.tsx</files>
  <action>
    Create src/app/not-found.tsx:
    - Custom page with SFDAN branding
    - Friendly message: "This page doesn't exist"
    - Link back to homepage
    - Consistent with existing design (Tailwind, same colors)
  </action>
  <verify>Build succeeds, page renders</verify>
  <done>Custom 404 page exists</done>
</task>

<task type="auto">
  <name>Task 7: Improve SEO metadata</name>
  <files>src/app/layout.tsx</files>
  <action>
    Update src/app/layout.tsx:
    - Add Open Graph tags (og:title, og:description, og:image, og:url)
    - Add Twitter card meta tags
    - Add canonical URL
    - Add viewport meta tag if missing
  </action>
  <verify>Build succeeds</verify>
  <done>SEO metadata improved</done>
</task>

<task type="auto">
  <name>Task 8: Set up Playwright for E2E testing</name>
  <files>package.json, playwright.config.ts, tests/e2e.spec.ts</files>
  <action>
    Install Playwright and set up E2E tests:
    - Run: npm install -D @playwright/test
    - Run: npx playwright install chromium
    - Create playwright.config.ts with basic config
    - Create tests/e2e.spec.ts with:
      - Homepage loads without errors
      - Search input exists
      - Data table renders
      - Navigation to /assess works
  </action>
  <verify>npx playwright test passes</verify>
  <done>Playwright E2E tests configured and passing</done>
</task>

</tasks>

<verification>
- [ ] npm run test:run passes (all unit tests)
- [ ] npx playwright test passes (E2E tests)
- [ ] Build succeeds
- [ ] Custom 404 renders for invalid routes
</verification>

<success_criteria>
- Unit tests exist for all key business logic (scoring, agency-stats, self-assessment, export)
- Custom 404 page exists and is styled
- SEO metadata includes Open Graph tags
- E2E smoke tests verify core functionality
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish/06-01-SUMMARY.md`
</output>
